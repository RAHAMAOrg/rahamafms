<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rahama Financial Management System</title>
    <link rel="icon" type="image/png" href="RAHAMA Empowerment Logo Design (3).png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Archivo:wght@600;700&display=swap');
        
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #10b981;
            --accent: #34d399;
            --danger: #D32F2F;
            --warning: #F57C00;
            --success: #059669;
            --bg: #F5F7FA;
            --surface: #FFFFFF;
            --text: #1A1A1A;
            --text-muted: #616161;
            --border: #E0E0E0;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        .app {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            box-shadow: var(--shadow);
        }
        
        .logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }
        
        .logo h1 {
            font-family: 'Archivo', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: #059669;
            margin-bottom: 4px;
        }
        
        .logo p {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .user-info {
            padding: 16px 24px;
            background: var(--bg);
            margin: 0 16px 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .user-info label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .nav {
            list-style: none;
        }
        
        .nav button {
            width: 100%;
            padding: 12px 24px;
            text-align: left;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text);
            transition: all 0.2s;
            position: relative;
        }
        
        .nav button:hover {
            background: var(--bg);
            color: var(--primary);
        }
        
        .nav button.active {
            background: linear-gradient(90deg, rgba(0,121,107,0.1) 0%, transparent 100%);
            color: var(--primary);
            font-weight: 600;
        }
        
        .nav button.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
        }
        
        .portal-link {
            margin: 24px 16px 0;
            padding: 12px;
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            text-align: center;
            border-radius: 8px;
            text-decoration: none;
            display: block;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .portal-link:hover {
            background: linear-gradient(135deg, #047857, #065f46);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Main content */
        .main {
            padding: 32px 48px;
            max-width: 1400px;
        }
        
        .header {
            margin-bottom: 32px;
        }
        
        .header h2 {
            font-family: 'Archivo', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .header p {
            color: var(--text-muted);
            font-size: 14px;
        }
        
        /* Loading spinner */
        .loading-spinner {
            text-align: center;
            padding: 64px;
        }
        
        .loading-spinner i {
            font-size: 32px;
            color: #059669;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        /* Alert badges */
        .alert-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 24px;
        }
        
        .alert-badge.warning {
            background: #FFF3E0;
            color: var(--warning);
            border: 1px solid #FFE0B2;
        }
        
        .alert-badge.danger {
            background: #FFEBEE;
            color: var(--danger);
            border: 1px solid #FFCDD2;
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            gap: 20px;
            background: var(--surface);
            padding: 32px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .form-grid.two-col {
            grid-template-columns: 1fr 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group label .required {
            color: var(--danger);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--surface);
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5,150,105,0.1);
        }
        
        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: var(--danger);
        }
        
        .form-error {
            color: var(--danger);
            font-size: 12px;
            margin-top: -4px;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            font-style: italic;
        }
        
        .threshold-info {
            padding: 16px;
            background: #E8F5E9;
            border: 1px solid #C8E6C9;
            border-radius: 8px;
            font-size: 13px;
            color: var(--success);
            font-weight: 500;
        }
        
        .threshold-info.high {
            background: #FFF3E0;
            border-color: #FFE0B2;
            color: var(--warning);
        }
        
        /* File upload */
        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-upload-area:hover {
            border-color: #059669;
            background: rgba(5,150,105,0.05);
        }
        
        .file-upload-area.has-file {
            border-color: var(--success);
            background: #E8F5E9;
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #047857, #065f46);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(5,150,105,0.4);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Tables */
        .table-container {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--bg);
        }
        
        th {
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        
        td {
            padding: 16px;
            border-top: 1px solid var(--border);
            font-size: 14px;
        }
        
        tr:hover {
            background: var(--bg);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background: #FFF3E0;
            color: var(--warning);
        }
        
        .status-approved {
            background: #E8F5E9;
            color: var(--success);
        }
        
        .status-paid {
            background: #E3F2FD;
            color: #1976D2;
        }
        
        .status-retired {
            background: #F3E5F5;
            color: #7B1FA2;
        }
        
        .status-rejected {
            background: #FFEBEE;
            color: var(--danger);
        }
        
        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .stat-card h3 {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'Archivo', sans-serif;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .stat-card.danger .stat-value {
            color: var(--danger);
        }
        
        .stat-card.warning .stat-value {
            color: var(--warning);
        }
        
        .stat-card.success .stat-value {
            color: var(--success);
        }
        
        /* Budget bars */
        .budget-bar {
            margin-top: 12px;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .budget-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
        
        .budget-fill.warning {
            background: var(--warning);
        }
        
        .budget-fill.danger {
            background: var(--danger);
        }
        
        /* Action buttons in table */
        .action-btn {
            padding: 12px 18px;
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
            min-width: 180px;
        }
        
        .action-btn:hover {
            background: var(--bg);
        }
        
        .action-btn.approve {
            border-color: var(--success);
            color: var(--success);
        }
        
        .action-btn.approve:hover {
            background: var(--success);
            color: white;
        }
        
        .action-btn.reject {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .action-btn.reject:hover {
            background: var(--danger);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-muted);
        }
        
        .workflow-diagram {
            background: var(--surface);
            padding: 32px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 32px;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
        }
        
        .workflow-number {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .workflow-content {
            flex: 1;
        }
        
        .workflow-content strong {
            display: block;
            margin-bottom: 4px;
            color: var(--text);
        }
        
        .workflow-content span {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        /* Progress Tracker */
        .progress-tracker {
            background: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 24px;
        }
        
        .progress-timeline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin: 32px 0;
        }
        
        .progress-timeline::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 40px;
            right: 40px;
            height: 4px;
            background: var(--border);
            z-index: 0;
        }
        
        .progress-line {
            position: absolute;
            top: 20px;
            left: 40px;
            height: 4px;
            background: linear-gradient(90deg, #059669, #10b981);
            z-index: 1;
            transition: width 0.5s ease;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .progress-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--surface);
            border: 3px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: var(--text-muted);
            transition: all 0.3s;
        }
        
        .progress-step.completed .progress-icon {
            background: linear-gradient(135deg, #059669, #047857);
            border-color: #059669;
            color: white;
        }
        
        .progress-step.active .progress-icon {
            background: #10b981;
            border-color: #059669;
            color: white;
            animation: pulse 2s infinite;
        }
        
        .progress-step.rejected .progress-icon {
            background: var(--danger);
            border-color: var(--danger);
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(5,150,105,0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(5,150,105,0);
            }
        }
        
        .progress-label {
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            max-width: 100px;
        }
        
        .progress-step.completed .progress-label,
        .progress-step.active .progress-label {
            color: var(--text);
        }
        
        .progress-step.rejected .progress-label {
            color: var(--danger);
        }
        
        .progress-date {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .progress-note {
            background: var(--bg);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 4px solid #059669;
            margin-top: 16px;
        }
        
        .progress-note.warning {
            border-left-color: var(--warning);
            background: #FFF3E0;
        }
        
        .progress-note.danger {
            border-left-color: var(--danger);
            background: #FFEBEE;
        }
        
        .tracking-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tracking-card:hover {
            box-shadow: var(--shadow);
            transform: translateY(-2px);
        }
        
        .tracking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .tracking-ref {
            font-weight: 700;
            color: #059669;
        }
        
        .tracking-amount {
            font-weight: 700;
            color: var(--text);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar">
            <div class="logo">
    <img src="RAHAMA Empowerment Logo Design (3).png" alt="RAHAMA Logo" style="width: 80px; height: 80px; object-fit: contain; margin: 0 auto 12px; display: block;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
    <div style="display: none;">
        <h1>Rahama FMS</h1>
    </div>
    <p style="text-align: center;">Financial Management System</p>
</div>
            <div class="user-info">
                <label>Signed in as</label>
                <div id="loggedInUser" style="font-weight:600;"></div>
            </div>
            
            <ul class="nav">
                <li><button onclick="app.showView('dashboard')" class="active" data-view="dashboard">Dashboard</button></li>
                <li><button onclick="app.showView('conceptNote')" data-view="conceptNote">Create Concept Note</button></li>
                <li><button onclick="app.showView('payment')" data-view="payment">Request Payment</button></li>
                <li><button onclick="app.showView('retirement')" data-view="retirement">Submit Retirement</button></li>
                <li><button onclick="app.showView('approvals')" data-view="approvals">My Approvals</button></li>
                <li><button id="reportsBtn" onclick="app.showView('reports')" data-view="reports">Reports & Budget</button></li>
                <li><button onclick="app.showView('settings')" data-view="settings">Settings</button></li>
            </ul>
            
            <a href="https://rahamaorg.github.io/appraisal-system/" class="portal-link" target="_blank">
                ‚Üê Back to Staff Portal
            </a>
        </div>
        
        <div class="main" id="mainContent">
            <!-- Dynamic content loads here -->
        </div>
    </div>
    
    <script>
        const SUPABASE_URL = "https://sqygmoxpegbfxddglhbx.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxeWdtb3hwZWdiZnhkZGdsaGJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTYzNTcsImV4cCI6MjA4NjU3MjM1N30.Oi3Vhw4q4F58cyb1yhJ90fcjGIVNwp34CqMtfxswkr8";
        const STORAGE_BUCKET = 'fms-documents';  // Supabase Storage bucket name
        const MAX_FILE_SIZE = 5 * 1024 * 1024;  // 5MB limit

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const app = {
            currentUser: '',
            cache: {
                myConceptNotes: null,
                myPayments: null,
                myRetirements: null
            },
            data: {
                conceptNotes: [],
                payments: [],
                retirements: [],

                staff: [
                    'Musa Usman',
                    'Aisha Linatu Abdulrahman',
                    'Fatima Yusuf Matsayi',
                    'Khadijah Abdulrahman',
                    'Sani Hamisu',
                    'Salahuddeen Sambo',
                    'Ahmad Abdulrahman Tijjani',
                    'Maryam Abdulrahman Tijjani',
                    'Sumayya Adam',
                    'Aisha Umar',
                    'Paulina Paul',
                    'Fatima Tijjani'
                ],

                projects: [
                    { code: 'DRT102', name: 'Ascent Phase II', budget: 35000000 },
                    { code: 'CBA101', name: 'Community Health Initiative', budget: 16000000 },
                    { code: 'GEPP101', name: 'Girls Education & Protection Program GEPP', budget: 75000000 },
                    { code: 'AYP101', name: 'Adolescents and Young People Project', budget: 8000000 },
                    { code: 'TES101', name: 'TES', budget: 500000 },
                    { code: 'ADM001', name: 'Admin & Operations', budget: 1000000 }
                ],

                roles: {
                    'Aisha Linatu Abdulrahman': 'budgetOwner',
                    'Fatima Tijjani': 'ed',
                    'Khadijah Abdulrahman': 'procurement',
                    'Fatima Yusuf Matsayi': 'procurement',
                    'Musa Usman': 'procurement',
                    'Salahuddeen Sambo': 'finance',
                    'Sani Hamisu': 'finance'
                }
            },
            
            async init() {
                this.loadStartTime = Date.now();
                
                // URL takes priority
                const params = new URLSearchParams(window.location.search);
                const urlSession = params.get('session');

                if (urlSession) {
                    localStorage.setItem('pms_user', decodeURIComponent(urlSession));
                }

                const session = localStorage.getItem('pms_user');

                if (session) {
                    const user = JSON.parse(session);
                    this.currentUser = user.name;

                    const el = document.getElementById('loggedInUser');
                    if (el) el.innerText = user.name;

                    // Hide Reports if not authorized
                    const role = this.getUserRole();
                    const btn = document.getElementById('reportsBtn');

                    if (!['budgetOwner','ed','procurement','finance'].includes(role)) {
                        if (btn) btn.style.display = 'none';
                    }
                }

                // Show dashboard immediately, load data in background
                this.showView('dashboard');
                
                // Load data asynchronously (non-blocking)
                this.loadData().catch(error => {
                    console.error('Background data load error:', error);
                });
            },
            
            showLoading() {
                const content = document.getElementById('mainContent');
                content.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>';
            },
            
            clearCache() {
                this.cache = {
                    myConceptNotes: null,
                    myPayments: null,
                    myRetirements: null
                };
            },
            
            async loadData() {
                try {
                    const role = this.getUserRole();
                    
                    // Strategy 1: If staff, load only their data
                    if (role === 'staff') {
                        const [cnResult, payResult, retResult] = await Promise.all([
                            supabaseClient
                                .from('concept_notes')
                                .select('*')
                                .eq('staffName', this.currentUser)
                                .order('submittedDate', { ascending: false }),
                            supabaseClient
                                .from('payments')
                                .select('*')
                                .eq('staffName', this.currentUser)
                                .order('requestDate', { ascending: false }),
                            supabaseClient
                                .from('retirements')
                                .select('*')
                                .eq('staffName', this.currentUser)
                                .order('submittedDate', { ascending: false })
                        ]);

                        this.data.conceptNotes = cnResult.data || [];
                        this.data.payments = payResult.data || [];
                        this.data.retirements = retResult.data || [];
                    } 
                    // Strategy 2: If approver, load only pending items for their role + their own
                    else {
    const queries = [];

    // Always load user's own concept notes
    queries.push(
        supabaseClient
            .from('concept_notes')
            .select('*')
            .eq('staffName', this.currentUser)
            .order('submittedDate', { ascending: false })
    );

    // Load pending concept notes for approvers
    if (['budgetOwner','ed','procurement'].includes(role)) {
        queries.push(
            supabaseClient
                .from('concept_notes')
                .select('*')
                .eq('status', 'pending')
                .order('submittedDate', { ascending: false })
                .limit(50)
        );
    }

    // Finance loads approved + pending concept notes
    if (role === 'finance') {
        queries.push(
            supabaseClient
                .from('concept_notes')
                .select('*')
                .in('status', ['approved', 'pending'])
                .order('submittedDate', { ascending: false })
                .limit(100)
        );
    }

    // Load pending retirements for approvers
    if (['budgetOwner','ed','finance'].includes(role)) {
        queries.push(
            supabaseClient
                .from('retirements')
                .select('*')
                .eq('status', 'pending')
                .order('submittedDate', { ascending: false })
                .limit(50)
        );
    }

    // Load user's own payments
    queries.push(
        supabaseClient
            .from('payments')
            .select('*')
            .eq('staffName', this.currentUser)
            .order('requestDate', { ascending: false })
    );

    // Load user's own retirements
    queries.push(
        supabaseClient
            .from('retirements')
            .select('*')
            .eq('staffName', this.currentUser)
            .order('submittedDate', { ascending: false })
    );

    const results = await Promise.all(queries);

    const allConceptNotes = [];
    const allPayments = [];
    const allRetirements = [];
    const seenCN = new Set();
    const seenPay = new Set();
    const seenRet = new Set();

    results.forEach(result => {
        if (!result.data) return;

        result.data.forEach(item => {
            if (item.refNumber?.startsWith('CN')) {
                if (!seenCN.has(item.refNumber)) {
                    seenCN.add(item.refNumber);
                    allConceptNotes.push(item);
                }
            } else if (item.refNumber?.startsWith('PAY')) {
                if (!seenPay.has(item.refNumber)) {
                    seenPay.add(item.refNumber);
                    allPayments.push(item);
                }
            } else if (item.refNumber?.startsWith('RET')) {
                if (!seenRet.has(item.refNumber)) {
                    seenRet.add(item.refNumber);
                    allRetirements.push(item);
                }
            }
        });
    });

    this.data.conceptNotes = allConceptNotes;
    this.data.payments = allPayments;
    this.data.retirements = allRetirements;
}
                    // Load ALL payments for leadership & finance (needed for reports & budgets)
if (['budgetOwner','ed','finance'].includes(role)) {
    const { data: allPaymentsForReports } = await supabaseClient
        .from('payments')
        .select('*');

    if (allPaymentsForReports) {
        this.data.payments = allPaymentsForReports;
    }
}

                    // Clear cache when data is reloaded
                    this.clearCache();
                    
                    // Refresh current view if dashboard
                    if (document.querySelector('.nav button[data-view="dashboard"]')?.classList.contains('active')) {
                        this.renderDashboard(document.getElementById('mainContent'));
                    }

                } catch (error) {
                    console.error('Data load error:', error);
                    // Don't show error to user on background load
                    if (this.data.conceptNotes.length === 0) {
                        alert('Error loading data. Please refresh the page.');
                    }
                }
            },
            
            getUserRole() {
                return this.data.roles[this.currentUser] || 'staff';
            },
            
            getMyConceptNotes() {
                if (!this.cache.myConceptNotes) {
                    this.cache.myConceptNotes = this.data.conceptNotes.filter(
                        cn => cn.staffName === this.currentUser
                    );
                }
                return this.cache.myConceptNotes;
            },
            
            getMyPayments() {
                if (!this.cache.myPayments) {
                    this.cache.myPayments = this.data.payments.filter(
                        p => p.staffName === this.currentUser
                    );
                }
                return this.cache.myPayments;
            },
            
            getMyRetirements() {
                if (!this.cache.myRetirements) {
                    this.cache.myRetirements = this.data.retirements.filter(
                        r => r.staffName === this.currentUser
                    );
                }
                return this.cache.myRetirements;
            },
            
            updateProjectBudget(projectCode) {
                const project = this.data.projects.find(p => p.code === projectCode);
                const infoDiv = document.getElementById('budgetInfo');
                
                if (project && infoDiv) {
                    const spent = this.getProjectSpent(projectCode);
                    const remaining = project.budget - spent;
                    const percentUsed = (spent / project.budget * 100).toFixed(1);
                    
                    infoDiv.innerHTML = `
                        <strong>Budget Status:</strong> ‚Ç¶${remaining.toLocaleString()} remaining 
                        (${percentUsed}% used of ‚Ç¶${project.budget.toLocaleString()})
                    `;
                    
                    if (percentUsed > 80) {
                        infoDiv.className = 'threshold-info high';
                    } else {
                        infoDiv.className = 'threshold-info';
                    }
                    
                    infoDiv.style.display = 'block';
                }
            },
            
            getProjectSpent(projectCode) {
                return this.data.payments
                    .filter(p => p.projectCode === projectCode && p.status === 'paid')
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
            },
            
            // FILE UPLOAD HELPERS with Supabase Storage
            async uploadFile(file, type = 'general') {
                if (!file) return null;
                
                // Validate file size
                if (file.size > MAX_FILE_SIZE) {
                    throw new Error(`File too large. Maximum size is ${MAX_FILE_SIZE / 1024 / 1024}MB`);
                }
                
                // Create unique filename
                const timestamp = Date.now();
                const sanitizedName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const fileName = `${type}/${timestamp}_${sanitizedName}`;
                
                try {
                    // Upload to Supabase Storage
                    const { data, error } = await supabaseClient.storage
                        .from(STORAGE_BUCKET)
                        .upload(fileName, file);
                    
                    if (error) throw error;
                    
                    // Get public URL
                    const { data: urlData } = supabaseClient.storage
                        .from(STORAGE_BUCKET)
                        .getPublicUrl(fileName);
                    
                    return {
                        url: urlData.publicUrl,
                        fileName: file.name,
                        size: file.size,
                        type: file.type
                    };
                } catch (error) {
                    console.error('Upload error:', error);
                    throw new Error('Failed to upload file: ' + error.message);
                }
            },
            
            async downloadFile(fileUrl, fileName) {
                try {
                    const response = await fetch(fileUrl);
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName || 'download';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Download error:', error);
                    alert('Failed to download file');
                }
            },
            
            // INPUT VALIDATION
            validateAccountNumber(accountNumber) {
                return /^\d{10}$/.test(accountNumber);
            },
            
            validateAmount(amount) {
                return !isNaN(amount) && amount > 0;
            },
            
            showError(elementId, message) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.classList.add('error');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'form-error';
                    errorDiv.textContent = message;
                    element.parentNode.appendChild(errorDiv);
                }
            },
            
            clearErrors() {
                document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
                document.querySelectorAll('.form-error').forEach(el => el.remove());
            },
            
            showView(viewName) {
                // Update active nav
                document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
                const targetBtn = document.querySelector(`.nav button[data-view="${viewName}"]`);
                if (targetBtn) targetBtn.classList.add('active');
                
                const content = document.getElementById('mainContent');
                
                if (!this.currentUser) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <h2>User session not found</h2>
                            <p>Please login from the Staff Portal.</p>
                        </div>
                    `;
                    return;
                }
                
                // Show loading first
                this.showLoading();
                
                // Render after short delay to show loading
                setTimeout(() => {
                    switch(viewName) {
                        case 'dashboard': this.renderDashboard(content); break;
                        case 'conceptNote': this.renderConceptNoteForm(content); break;
                        case 'payment': this.renderPaymentForm(content); break;
                        case 'retirement': this.renderRetirementForm(content); break;
                        case 'approvals': this.renderApprovals(content); break;
                        case 'reports': this.renderReports(content); break;
                        case 'settings': this.renderSettings(content); break;
                    }
                }, 100);
            },
            
            renderDashboard(content) {
                const myConceptNotes = this.getMyConceptNotes();
                const myPayments = this.getMyPayments();
                const myRetirements = this.getMyRetirements();
                
                // Show skeleton if data is still loading
                if (myConceptNotes.length === 0 && myPayments.length === 0 && myRetirements.length === 0) {
                    const loadingTime = Date.now() - (this.loadStartTime || Date.now());
                    if (loadingTime < 2000) {
                        content.innerHTML = `
                            <div class="header">
                                <h2>Dashboard</h2>
                                <p>Welcome back, ${this.currentUser.split(' ')[0]}</p>
                            </div>
                            <div class="stats-grid">
                                ${[1,2,3,4].map(() => `
                                    <div class="stat-card" style="background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); animation: shimmer 1.5s infinite;">
                                        <div style="height: 20px; background: #ddd; border-radius: 4px; margin-bottom: 12px;"></div>
                                        <div style="height: 40px; background: #ddd; border-radius: 4px;"></div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="loading-spinner" style="padding: 32px;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p style="margin-top: 16px; color: var(--text-muted);">Loading your data...</p>
                            </div>
                        `;
                        
                        // Try again in 500ms
                        setTimeout(() => this.renderDashboard(content), 500);
                        return;
                    }
                }
                
                const unretiredPayments = myPayments.filter(p => 
                    p.status === 'paid' && !myRetirements.find(r => r.paymentRef === p.refNumber)
                );
                
                const overdueRetirements = unretiredPayments.filter(p => {
                    if (!p.paidDate) return false;
                    const daysSince = Math.floor((Date.now() - new Date(p.paidDate)) / (1000 * 60 * 60 * 24));
                    return daysSince > 5;
                });
                
                const activeUnretired = unretiredPayments.filter(p => p.paidDate);

const isLocked = activeUnretired.length >= 2 || overdueRetirements.length > 0;
                
                // Get current time for greeting
                const hour = new Date().getHours();
                const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Dashboard</h2>
                        <p>${greeting}, ${this.currentUser.split(' ')[0]} ‚Ä¢ <span style="color: var(--success);">‚óè System Online</span></p>
                    </div>
                    
                    ${myConceptNotes.length === 0 && myPayments.length === 0 && myRetirements.length === 0 ? `
                        <div style="background: linear-gradient(135deg, var(--primary-light), var(--primary)); padding: 48px; border-radius: 16px; text-align: center; color: white; margin-bottom: 32px;">
                            <h2 style="font-size: 28px; margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Welcome to RAHAMA FMS! üéâ</h2>
                            <p style="font-size: 16px; opacity: 0.95; max-width: 600px; margin: 0 auto 24px;">
                                You're all set to start managing your financial workflows. Create your first concept note to get started.
                            </p>
                            <button onclick="app.showView('conceptNote')" class="btn" style="background: white; color: var(--primary); padding: 16px 32px; font-size: 16px; font-weight: 700; border: none; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                Create Your First Concept Note ‚Üí
                            </button>
                        </div>
                    ` : ''}
                    
                    ${isLocked ? `
                        <div class="alert-badge danger">
                            ‚ö†Ô∏è Your account is locked: ${unretiredPayments.length >= 2 ? 
                                `${unretiredPayments.length} unretired advances` : 
                                `Retirement overdue by ${Math.floor((Date.now() - new Date(overdueRetirements[0].paidDate)) / (1000 * 60 * 60 * 24))} days`}
                        </div>
                    ` : ''}
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Concept Notes</h3>
                            <div class="stat-value">${myConceptNotes.length}</div>
                            <div class="stat-label">Total submitted</div>
                        </div>
                        <div class="stat-card ${unretiredPayments.length > 0 ? 'warning' : 'success'}">
                            <h3>Unretired Advances</h3>
                            <div class="stat-value">${unretiredPayments.length}</div>
                            <div class="stat-label">${unretiredPayments.length >= 2 ? 'Account locked!' : 'Active advances'}</div>
                        </div>
                        <div class="stat-card ${overdueRetirements.length > 0 ? 'danger' : ''}">
                            <h3>Overdue Retirements</h3>
                            <div class="stat-value">${overdueRetirements.length}</div>
                            <div class="stat-label">${overdueRetirements.length > 0 ? 'Action required!' : 'All current'}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Paid</h3>
                            <div class="stat-value">‚Ç¶${myPayments.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.amount, 0).toLocaleString()}</div>
                            <div class="stat-label">Lifetime payments</div>
                        </div>
                    </div>
                    
                    <div class="workflow-diagram">
                        <h3 style="margin-bottom: 20px; font-family: 'Archivo', sans-serif;">Financial Workflow</h3>
                        <div class="workflow-step">
                            <div class="workflow-number">1</div>
                            <div class="workflow-content">
                                <strong>Staff creates Concept Note/ToR</strong>
                                <span>Submitted to Budget Owner for review</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">2</div>
                            <div class="workflow-content">
                                <strong>Budget Owner Review</strong>
                                <span>Approves if ‚â§‚Ç¶1M, forwards to ED if >‚Ç¶1M, routes to Procurement if items needed</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">3</div>
                            <div class="workflow-content">
                                <strong>Procurement (if needed)</strong>
                                <span>Procures items, attaches GRR + evidence, pushes to Finance</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">4</div>
                            <div class="workflow-content">
                                <strong>Finance processes payment</strong>
                                <span>Reviews documents, makes payment, shares confirmation</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">5</div>
                            <div class="workflow-content">
                                <strong>Staff submits retirement</strong>
                                <span>Within 5 days of payment receipt</span>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">My Concept Notes</h3>
                    ${myConceptNotes.length === 0 ? `
                        <div class="empty-state" style="padding: 32px;">
                            <p>No concept notes yet. Create one to get started!</p>
                        </div>
                    ` : `
                        <div style="margin-bottom: 32px;">
                            ${myConceptNotes.slice(0, 5).map(cn => {
                                const progress = this.getConceptNoteProgress(cn);
                                return `
                                    <div class="tracking-card" onclick="app.showConceptNoteTracking('${cn.refNumber}')">
                                        <div class="tracking-header">
                                            <div>
                                                <span class="tracking-ref">${cn.refNumber}</span>
                                                <span style="color: var(--text-muted); font-size: 13px; margin-left: 12px;">${cn.activityTitle}</span>
                                            </div>
                                            <span class="tracking-amount">‚Ç¶${cn.estimatedCost.toLocaleString()}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="flex: 1; margin-right: 16px;">
                                                <div style="height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
                                                    <div style="height: 100%; background: ${cn.status === 'rejected' ? 'var(--danger)' : 'var(--primary)'}; width: ${progress.percentComplete}%; transition: width 0.3s;"></div>
                                                </div>
                                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                                    ${progress.currentStep}
                                                </div>
                                            </div>
                                            <span class="status-badge status-${cn.status}">${cn.status}</span>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                    
                    <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Recent Activity</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Reference</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.getRecentActivity().map(item => `
                                    <tr>
                                        <td>${new Date(item.date).toLocaleDateString()}</td>
                                        <td>${item.type}</td>
                                        <td>${item.ref}</td>
                                        <td>${item.amount ? '‚Ç¶' + item.amount.toLocaleString() : '-'}</td>
                                        <td><span class="status-badge status-${item.status}">${item.status}</span></td>
                                    </tr>
                                `).join('') || '<tr><td colspan="5" style="text-align: center; padding: 32px; color: #999;">No recent activity</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            getRecentActivity() {
                const activity = [];
                const myConceptNotes = this.getMyConceptNotes();
                const myPayments = this.getMyPayments();
                const myRetirements = this.getMyRetirements();
                
                myConceptNotes.forEach(cn => {
                    activity.push({
                        date: cn.submittedDate,
                        type: 'Concept Note',
                        ref: cn.refNumber,
                        amount: cn.estimatedCost,
                        status: cn.status
                    });
                });
                
                myPayments.forEach(p => {
                    activity.push({
                        date: p.requestDate,
                        type: 'Payment',
                        ref: p.refNumber,
                        amount: p.amount,
                        status: p.status
                    });
                });
                
                myRetirements.forEach(r => {
                    activity.push({
                        date: r.submittedDate,
                        type: 'Retirement',
                        ref: r.refNumber,
                        amount: r.actualSpent,
                        status: r.status
                    });
                });
                
                return activity.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            },
            
            getConceptNoteProgress(cn) {
                const steps = [
                    { id: 'submitted', label: 'Submitted', icon: 'üìù', date: cn.submittedDate },
                    { id: 'budgetOwner', label: 'Budget Owner', icon: 'üë§', date: null },
                    { id: 'ed', label: 'Executive Director', icon: 'üëî', date: cn.forwardedToED },
                    { id: 'procurement', label: 'Procurement', icon: 'üõí', date: cn.sentToProcurement },
                    { id: 'approved', label: 'Approved', icon: '‚úì', date: cn.approvedDate }
                ];
                
                let progress = {
                    steps: [],
                    currentStep: '',
                    percentComplete: 0,
                    message: ''
                };
                
                // Filter out skipped steps
                let activeSteps = [steps[0]]; // Always include submitted
                
                // Check if it went through budget owner
                if (cn.status === 'pending' && cn.currentApprover === 'budgetOwner') {
                    activeSteps.push({ ...steps[1], status: 'active' });
                    progress.currentStep = 'Budget Owner Review';
                    progress.message = 'Awaiting Budget Owner approval';
                }
                
                // Check if forwarded to ED
                if (cn.forwardedToED || (cn.status === 'pending' && cn.currentApprover === 'ed')) {
                    activeSteps.push({ ...steps[1], status: 'completed', date: cn.submittedDate });
                    activeSteps.push({ 
                        ...steps[2], 
                        status: cn.currentApprover === 'ed' ? 'active' : 'completed' 
                    });
                    if (cn.currentApprover === 'ed') {
                        progress.currentStep = 'Executive Director Review';
                        progress.message = 'Awaiting ED approval';
                    }
                }
                
                // Check if sent to procurement
                if (cn.sentToProcurement || (cn.status === 'pending' && cn.currentApprover === 'procurement')) {
                    if (!cn.forwardedToED) {
                        activeSteps.push({ ...steps[1], status: 'completed', date: cn.submittedDate });
                    }
                    activeSteps.push({ 
                        ...steps[3], 
                        status: cn.currentApprover === 'procurement' ? 'active' : 'completed' 
                    });
                    if (cn.currentApprover === 'procurement') {
                        progress.currentStep = 'Procurement Processing';
                        progress.message = 'Items being procured';
                    }
                }
                
                // Check if approved
                if (cn.status === 'approved') {
                    if (!cn.sentToProcurement && !cn.forwardedToED) {
                        activeSteps.push({ ...steps[1], status: 'completed', date: cn.submittedDate });
                    }
                    activeSteps.push({ ...steps[4], status: 'completed' });
                    progress.currentStep = 'Approved';
                    progress.message = '‚úì Concept note approved! Payment can be requested.';
                }
                
                // Check if rejected
                if (cn.status === 'rejected') {
                    const lastStep = activeSteps[activeSteps.length - 1];
                    lastStep.status = 'rejected';
                    progress.currentStep = 'Rejected';
                    progress.message = `‚ùå Rejected: ${cn.rejectionReason || 'See comments'}`;
                }
                
                progress.steps = activeSteps;
                progress.percentComplete = ((activeSteps.filter(s => s.status === 'completed').length) / activeSteps.length) * 100;
                
                return progress;
            },
            
            showConceptNoteTracking(refNumber) {
                const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
                if (!cn) return;
                
                const progress = this.getConceptNoteProgress(cn);
                const content = document.getElementById('mainContent');
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Track Concept Note</h2>
                        <p>Follow your concept note through the approval process</p>
                    </div>
                    
                    <div class="progress-tracker">
                        <div class="tracking-header">
                            <div>
                                <h3 style="font-family: 'Archivo', sans-serif; margin-bottom: 8px;">${cn.activityTitle}</h3>
                                <p style="color: var(--text-muted); font-size: 14px;">
                                    ${cn.refNumber} ‚Ä¢ ‚Ç¶${cn.estimatedCost.toLocaleString()}
                                </p>
                            </div>
                            <span class="status-badge status-${cn.status}">${cn.status}</span>
                        </div>
                        
                        <div class="progress-timeline">
                            <div class="progress-line" style="width: ${progress.percentComplete}%"></div>
                            ${progress.steps.map((step, index) => `
                                <div class="progress-step ${step.status || ''}">
                                    <div class="progress-icon">
                                        ${step.status === 'completed' ? '‚úì' : 
                                          step.status === 'rejected' ? '‚úó' : 
                                          step.icon || (index + 1)}
                                    </div>
                                    <div class="progress-label">
                                        ${step.label}
                                        ${step.date ? `<div class="progress-date">${new Date(step.date).toLocaleDateString()}</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="progress-note ${cn.status === 'rejected' ? 'danger' : cn.status === 'approved' ? '' : 'warning'}">
                            <strong>${progress.currentStep}</strong><br>
                            <span style="font-size: 13px;">${progress.message}</span>
                        </div>
                        
                        ${cn.status === 'approved' ? `
                            <div style="margin-top: 16px;">
                                <button class="btn btn-primary" onclick="app.showView('payment')">
                                    Request Payment ‚Üí
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="form-grid two-col">
                        <div class="form-group">
                            <label>Project Code</label>
                            <input type="text" value="${cn.projectCode}" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Requires Procurement</label>
                            <input type="text" value="${cn.requiresProcurement === 'yes' ? 'Yes' : 'No'}" readonly>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Objective</label>
                            <textarea rows="3" readonly>${cn.objective}</textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Description</label>
                            <textarea rows="4" readonly>${cn.description}</textarea>
                        </div>
                        
                        ${cn.procurementNotes ? `
                            <div class="form-group full-width">
                                <label>Procurement Notes</label>
                                <textarea rows="2" readonly>${cn.procurementNotes}</textarea>
                            </div>
                        ` : ''}
                        
                        ${cn.rejectionReason ? `
                            <div class="form-group full-width">
                                <label style="color: var(--danger);">Rejection Reason</label>
                                <textarea rows="2" readonly style="border-color: var(--danger);">${cn.rejectionReason}</textarea>
                            </div>
                        ` : ''}
                        
                        <div class="btn-group full-width">
                            <button class="btn btn-primary" onclick="app.showView('dashboard')">
                                ‚Üê Back to Dashboard
                            </button>
                        </div>
                    </div>
                `;
            },
            
            renderConceptNoteForm(content) {
                content.innerHTML = `
                    <div class="header">
                        <h2>Create Concept Note</h2>
                        <p>Step 1: Develop your concept note or Terms of Reference</p>
                    </div>
                    
                    <form class="form-grid two-col" onsubmit="app.submitConceptNote(event)">
                        <div class="form-group">
                            <label>Project Code <span class="required">*</span></label>
                            <select name="projectCode" id="projectCode" required>
                                <option value="">Select project</option>
                                ${this.data.projects.map(p => `
                                    <option value="${p.code}">${p.code} - ${p.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Activity Title <span class="required">*</span></label>
                            <input type="text" name="activityTitle" id="activityTitle" required placeholder="e.g., Radio Jingle Production - Kano">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Objective <span class="required">*</span></label>
                            <textarea name="objective" id="objective" required placeholder="What is the purpose of this activity?"></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Description <span class="required">*</span></label>
                            <textarea name="description" id="description" required placeholder="Detailed description of the activity"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Estimated Cost (‚Ç¶) <span class="required">*</span></label>
                            <input type="number" name="estimatedCost" id="estimatedCost" required min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Implementation Date <span class="required">*</span></label>
                            <input type="date" name="ImplementationDate" id="ImplementationDate" required placeholder="e.g., when is your activity">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Are items/services to be procured? <span class="required">*</span></label>
                            <select name="requiresProcurement" required>
                                <option value="no">No - Direct payment</option>
                                <option value="yes">Yes - Procurement needed</option>
                            </select>
                            <span class="form-hint">Select "Yes" if items need to be purchased by Procurement team</span>
                        </div>
                        
                        <div class="btn-group full-width">
                            <button type="submit" class="btn btn-primary">Submit Concept Note</button>
                            <button type="button" class="btn btn-secondary" onclick="app.showView('dashboard')">Cancel</button>
                        </div>
                    </form>
                `;
            },
            
            async submitConceptNote(event) {
                event.preventDefault();
                this.clearErrors();
                
                const form = event.target;
                const formData = new FormData(form);
                
                // Validate
                const amount = parseFloat(formData.get('estimatedCost'));
                if (!this.validateAmount(amount)) {
                    this.showError('estimatedCost', 'Please enter a valid amount');
                    return;
                }
                
                try {
                    const conceptNote = {
                        refNumber: 'CN' + Date.now(),
                        staffName: this.currentUser,
                        projectCode: formData.get('projectCode'),
                        activityTitle: formData.get('activityTitle'),
                        objective: formData.get('objective'),
                        description: formData.get('description'),
                        estimatedCost: amount,
                        requiresProcurement: formData.get('requiresProcurement'),
                        status: 'pending',
                        currentApprover: 'budgetOwner',
                        submittedDate: new Date().toISOString()
                    };
                    
                    const { data, error } = await supabaseClient
                        .from('concept_notes')
                        .insert([conceptNote])
                        .select();
                    
                    if (error) throw error;
                    
                    // Update local data without full reload
                    this.data.conceptNotes.unshift(data[0]);
                    this.clearCache();
                    
                    alert('Concept note submitted successfully!');
                    this.showView('dashboard');
                } catch (error) {
                    console.error('Submit error:', error);
                    alert('Error submitting concept note: ' + error.message);
                }
            },
            
            renderPaymentForm(content) {
                const approvedNotes = this.data.conceptNotes.filter(cn => 
                    cn.staffName === this.currentUser && cn.status === 'approved'
                );
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Request Payment</h2>
                        <p>Submit a payment request for an approved concept note</p>
                    </div>
                    
                    <form class="form-grid two-col" onsubmit="app.submitPayment(event)">
                        <div class="form-group full-width">
                            <label>Select Approved Concept Note <span class="required">*</span></label>
                            <select name="conceptNoteId" required onchange="app.loadConceptNoteDetails(this.value)">
                                <option value="">Choose a concept note</option>
                                ${approvedNotes.map(cn => `
                                    <option value="${cn.id}">${cn.refNumber} - ${cn.activityTitle}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div id="conceptNoteDetails" style="display: none;" class="form-group full-width">
                            <div class="threshold-info">
                                <div id="cnDetailsContent"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Amount (‚Ç¶) <span class="required">*</span></label>
                            <input type="number" name="amount" id="amount" required min="0" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Method <span class="required">*</span></label>
                            <select name="paymentMethod" required>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="cash">Cash</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Justification</label>
                            <textarea name="justification" placeholder="Additional payment information"></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Beneficiary List (Optional)</label>
                            <div class="file-upload-area" id="beneficiaryUploadArea" onclick="document.getElementById('beneficiaryFile').click()">
                                <p>üìé Click to upload attendance or payment list</p>
                                <span class="form-hint">Maximum 5MB - Excel, CSV, PDF, or Image</span>
                            </div>
                            <input type="file" id="beneficiaryFile" accept=".xlsx,.xls,.csv,.pdf,.jpg,.png" style="display:none" onchange="app.handleBeneficiaryUpload(this)">
                        </div>
                        <div id="bankDetailsSection">
                        <div class="form-group">
                            <label>Account Name <span class="required">*</span></label>
                            <input type="text" name="accountName" id="accountName" required placeholder="Name as it appears on bank account">
                        </div>

                        <div class="form-group">
                            <label>Account Number <span class="required">*</span></label>
                            <input type="text" name="accountNumber" id="accountNumber" required pattern="[0-9]{10}" maxlength="10" placeholder="10-digit account number">
                        </div>

                        <div class="form-group full-width">
                            <label>Bank Name <span class="required">*</span></label>
                            <select name="bankName" id="bankName" required>
                                <option value="">Select Bank</option>
                                <option value="Access Bank">Access Bank</option>
                                <option value="Fidelity Bank">Fidelity Bank</option>
                                <option value="First Bank">First Bank</option>
                                <option value="FCMB">FCMB</option>
                                <option value="GTBank">GTBank</option>
                                <option value="Keystone Bank">Keystone Bank</option>
                                <option value="Polaris Bank">Polaris Bank</option>
                                <option value="Stanbic IBTC">Stanbic IBTC</option>
                                <option value="UBA">UBA</option>
                                <option value="Union Bank">Union Bank</option>
                                <option value="Unity Bank">Unity Bank</option>
                                <option value="Wema Bank">Wema Bank</option>
                                <option value="Zenith Bank">Zenith Bank</option>
                            </select>
                        </div>
                        </div>

                        <div class="btn-group full-width">
                            <button type="submit" class="btn btn-primary" id="submitPaymentBtn">Submit Payment Request</button>
                            <button type="button" class="btn btn-secondary" onclick="app.showView('dashboard')">Cancel</button>
                        </div>
                    </form>
                `;
            },
            
          handleBeneficiaryUpload(input) {
    const area = document.getElementById('beneficiaryUploadArea');
    const file = input.files[0];
    const bankSection = document.getElementById('bankDetailsSection');
    
    if (file) {
        if (file.size > MAX_FILE_SIZE) {
            alert(`File too large! Maximum size is ${MAX_FILE_SIZE / 1024 / 1024}MB`);
            input.value = '';
            return;
        }
        
        area.classList.add('has-file');
        area.innerHTML = `
            <p>‚úì ${file.name}</p>
            <span class="form-hint">${(file.size / 1024).toFixed(1)} KB ‚Äî Bank details not needed for batch payments</span>
        `;
        
        // Hide bank details and remove required
        if (bankSection) {
            bankSection.style.display = 'none';
            bankSection.querySelectorAll('[required]').forEach(el => {
                el.removeAttribute('required');
                el.value = '';
            });
        }
    } else {
        // Show bank details again if file removed
        if (bankSection) {
            bankSection.style.display = '';
            document.getElementById('accountName').setAttribute('required', '');
            document.getElementById('accountNumber').setAttribute('required', '');
            document.getElementById('bankName').setAttribute('required', '');
        }
    }
},
            
            loadConceptNoteDetails(id) {
                const cn = this.data.conceptNotes.find(c => c.id == id);
                const detailsDiv = document.getElementById('conceptNoteDetails');
                const contentDiv = document.getElementById('cnDetailsContent');
                
                if (cn && detailsDiv && contentDiv) {
                    detailsDiv.style.display = 'block';
                    contentDiv.innerHTML = `
                        <strong>Activity:</strong> ${cn.activityTitle}<br>
                        <strong>Estimated Cost:</strong> ‚Ç¶${cn.estimatedCost.toLocaleString()}<br>
                        <strong>Project:</strong> ${cn.projectCode}
                    `;
                }
            },
            
            async submitPayment(event) {
                event.preventDefault();
                this.clearErrors();
                
                const form = event.target;
                const formData = new FormData(form);
                const conceptNote = this.data.conceptNotes.find(
    c => c.id == formData.get('conceptNoteId')
        );
                const submitBtn = document.getElementById('submitPaymentBtn');
                
                // Validate
                const amount = parseFloat(formData.get('amount'));
                if (!this.validateAmount(amount)) {
                    this.showError('amount', 'Please enter a valid amount');
                    return;
                }
                const accountNumber = formData.get('accountNumber');
const hasBeneficiaryFile = document.getElementById('beneficiaryFile').files.length > 0;
if (!hasBeneficiaryFile && !this.validateAccountNumber(accountNumber)) {
    this.showError('accountNumber', 'Account number must be exactly 10 digits');
    return;
}
                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Uploading...';
                    
                    // Upload beneficiary file if provided
                    const file = document.getElementById('beneficiaryFile').files[0];
                    let beneficiaryFileData = null;
                    
                    if (file) {
                        beneficiaryFileData = await this.uploadFile(file, 'beneficiaries');
                    }
                    
                    const payment = {
                        refNumber: 'PAY' + Date.now(),
                        conceptNoteId: parseInt(formData.get('conceptNoteId')),
                        staffName: this.currentUser,
                        amount: amount,
                        paymentMethod: formData.get('paymentMethod'),
                        justification: formData.get('justification'),
                        accountName: formData.get('accountName'),
                        accountNumber: accountNumber,
                        bankName: formData.get('bankName'),
                        beneficiaryFileUrl: beneficiaryFileData?.url,
                        beneficiaryFileName: beneficiaryFileData?.fileName,
                        status: 'pending',
                        requestDate: new Date().toISOString(),
                        conceptNoteRef: conceptNote?.refNumber,
projectCode: conceptNote?.projectCode,
                    };
                    
                    const { data, error } = await supabaseClient
                        .from('payments')
                        .insert([payment])
                        .select();
                    
                    if (error) throw error;
                    
                    // Update local data
                    this.data.payments.unshift(data[0]);
                    this.clearCache();
                    
                    alert('Payment request submitted successfully!');
                    this.showView('dashboard');
                } catch (error) {
                    console.error('Submit error:', error);
                    alert('Error submitting payment: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Payment Request';
                }
            },
            
            renderRetirementForm(content) {
                const userRole = this.getUserRole();
                const myPayments = this.getMyPayments();
                
               const paidPayments = this.data.payments.filter(p => {

    // Must be paid
    if (p.status !== 'paid') return false;

    // Must have been processed (safety check)
    if (!p.paidDate) return false;

    // Must not already have a retirement
    if (this.data.retirements.find(r => r.paymentRef === p.refNumber)) return false;

    // STAFF can only retire their own payments
    if (p.staffName === this.currentUser) {
        return (
            p.staffName === this.currentUser &&
            p.retirementresponsibility === 'staff'
        );
    }

    // PROCUREMENT retires procurement payments
    if (userRole === 'procurement') {
        return p.retirementresponsibility === 'procurement';
    }

    return false;
});
                
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Submit Retirement</h2>
                        <p>${userRole === 'procurement' ? 'Retire procured activities' : 'Retire advance payments (available 5 days after payment)'}</p>
                    </div>
        
                    
                    ${paidPayments.length === 0 ? `
                        <div class="empty-state">
                            <h3>No payments to retire</h3>
                            <p>${userRole === 'procurement' ? 
                                "You don't have any procured activities that need retirement." : 
                                "You don't have any paid advances ready for retirement."}</p>
                        </div>
                    ` : `
                        <form class="form-grid two-col" onsubmit="app.submitRetirement(event)">
                            <div class="form-group full-width">
                                <label>Select Payment to Retire <span class="required">*</span></label>
                                <select name="paymentRef" required onchange="app.loadPaymentDetails(this.value)">
                                    <option value="">Choose a payment</option>
                                    ${paidPayments.map(p => {
                                        const daysSince = Math.floor((Date.now() - new Date(p.paidDate)) / (1000 * 60 * 60 * 24));
                                        return `<option value="${p.refNumber}">${p.refNumber} - ‚Ç¶${p.amount.toLocaleString()} (Paid ${daysSince} days ago)</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Actual Amount Spent (‚Ç¶) <span class="required">*</span></label>
                                <input type="number" name="actualSpent" id="actualSpent" required min="0" step="0.01">
                            </div>
                            
                            <div class="form-group">
                                <label>Amount to Return (‚Ç¶)</label>
                                <input type="number" name="amountReturned" min="0" step="0.01" value="0">
                            </div>
                            
                            <div class="form-group full-width">
                                <label>Expenditure Details <span class="required">*</span></label>
                                <textarea name="expenditureDetails" required placeholder="Describe how the funds were spent"></textarea>
                            </div>
                            
                            <div class="form-group full-width">
    <label>Upload Receipts <span class="required">*</span></label>
    <div class="file-upload-area" id="retirementUploadArea" onclick="document.getElementById('retirementFile').click()">
        <p>üìé Click to upload receipt(s)</p>
        <span class="form-hint">PDF, JPG, PNG ‚Äî Max 5MB</span>
    </div>
    <input type="file" id="retirementFile" accept=".pdf,.jpg,.jpeg,.png" required style="display:none" onchange="app.handleRetirementUpload(this)">
</div>
                            
                            <div class="btn-group full-width">
                                <button type="submit" class="btn btn-primary">Submit Retirement</button>
                                <button type="button" class="btn btn-secondary" onclick="app.showView('dashboard')">Cancel</button>
                            </div>
                        </form>
                    `}
                `;
            },
            
            loadPaymentDetails(refNumber) {
                const payment = this.data.payments.find(p => p.refNumber === refNumber);
                if (payment) {
                    const form = document.querySelector('form');
                    const actualSpentInput = form.querySelector('[name="actualSpent"]');
                    if (actualSpentInput) {
                        actualSpentInput.max = payment.amount;
                    }
                }
            },
            
            async submitRetirement(event) {
                event.preventDefault();
                this.clearErrors();
                
                const form = event.target;
                const formData = new FormData(form);
                
                // Validate
                const actualSpent = parseFloat(formData.get('actualSpent'));
                if (!this.validateAmount(actualSpent)) {
                    this.showError('actualSpent', 'Please enter a valid amount');
                    return;
                }
                // Get uploaded receipt file
const file = document.getElementById('retirementFile').files[0];
let receiptFileData = null;

// Upload if file exists
if (file) {
    receiptFileData = await this.uploadFile(file, 'retirements');
}
                try {
                    const retirement = {
                        refNumber: 'RET' + Date.now(),
                        staffName: this.currentUser,
                        paymentRef: formData.get('paymentRef'),
                        actualSpent: actualSpent,
                        amountReturned: parseFloat(formData.get('amountReturned')) || 0,
                        expenditureDetails: formData.get('expenditureDetails'),
                        receiptFileUrl: receiptFileData?.url,
receiptFileName: receiptFileData?.fileName,
                        status: 'pending',
                        submittedDate: new Date().toISOString()
                    };
                    
                    const { data, error } = await supabaseClient
                        .from('retirements')
                        .insert([retirement])
                        .select();
                    
                    if (error) throw error;
                    
                    // Update local data
                    this.data.retirements.unshift(data[0]);
                    this.clearCache();
                    
                    alert('Retirement submitted successfully!');
                    this.showView('dashboard');
                } catch (error) {
                    console.error('Submit error:', error);
                    alert('Error submitting retirement: ' + error.message);
                }
            },
            
            renderApprovals(content) {
                const role = this.getUserRole();
                
                const pendingConceptNotes = this.data.conceptNotes.filter(cn => {
                    if (cn.status !== 'pending') return false;
                    
                    if (role === 'budgetOwner' && cn.currentApprover === 'budgetOwner') return true;
                    if (role === 'ed' && cn.currentApprover === 'ed') return true;
                    if (role === 'procurement' && cn.currentApprover === 'procurement') return true;
                    if (role === 'finance' && cn.status === 'approved') return true;
                    return false;
                });
                
                const pendingPayments = this.data.payments.filter(p => 
                    p.status === 'pending' && role === 'finance'
                );
                
                const pendingRetirements = this.data.retirements.filter(r => 
                    r.status === 'pending' && role === 'finance'
                );
                
                content.innerHTML = `
                    <div class="header">
                        <h2>My Approvals</h2>
                        <p>Items requiring your review and approval</p>
                    </div>
                    
                    ${pendingConceptNotes.length === 0 && pendingPayments.length === 0 && pendingRetirements.length === 0 ? `
                        <div class="empty-state">
                            <h3>No pending approvals</h3>
                            <p>You don't have any items waiting for your approval.</p>
                        </div>
                    ` : ''}
                    
                    ${pendingConceptNotes.length > 0 ? `
                        <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Concept Notes (${pendingConceptNotes.length})</h3>
                        <div class="table-container" style="margin-bottom: 32px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref</th>
                                        <th>Staff</th>
                                        <th>Activity</th>
                                        <th>Project</th>
                                        <th>Amount</th>
                                        <th>Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingConceptNotes.map(cn => `
                                        <tr>
                                            <td>${cn.refNumber}</td>
                                            <td>${cn.staffName}</td>
                                            <td>${cn.activityTitle}</td>
                                            <td>${cn.projectCode}</td>
                                            <td>‚Ç¶${cn.estimatedCost.toLocaleString()}</td>
                                            <td>${new Date(cn.submittedDate).toLocaleDateString()}</td>
                                            <td>
                                                <button class="action-btn" onclick="app.viewConceptNoteDetails('${cn.refNumber}')" style="min-width:120px;margin-bottom:8px;border-color:var(--primary);color:var(--primary);">
                                                    üìÑ View Details
                                                </button><br>
                                                ${role === 'budgetOwner' ? `
                                                    ${cn.estimatedCost <= 1000000 ? `
                                                        <button class="action-btn approve" onclick="app.approveConceptNote('${cn.refNumber}', 'approve_under_1m')">
                                                            ‚úì Approve${cn.requiresProcurement === 'yes' ? ' ‚Üí Procurement' : ''}
                                                        </button>
                                                    ` : `
                                                        <button class="action-btn approve" onclick="app.approveConceptNote('${cn.refNumber}', 'forward_to_ed')">
                                                            ‚Üí Forward to ED (>‚Ç¶1M)
                                                        </button>
                                                    `}
                                                ` : role === 'ed' ? `
                                                    <button class="action-btn approve" onclick="app.approveConceptNote('${cn.refNumber}', 'ed_approve')">
                                                        ‚úì Approve${cn.requiresProcurement === 'yes' ? ' ‚Üí Procurement' : ''}
                                                    </button>
                                                ` : role === 'procurement' ? `
                                                    <button class="action-btn approve" onclick="app.showProcurementUpload('${cn.refNumber}')">
                                                        ‚úì Complete & Forward to Finance
                                                    </button>
                                                ` : ''}
                                                <button class="action-btn reject" onclick="app.rejectConceptNote('${cn.refNumber}')">
                                                    ‚úó Reject
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                    
                    ${pendingPayments.length > 0 ? `
                        <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Payment Requests (${pendingPayments.length})</h3>
                        <div class="table-container" style="margin-bottom: 32px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref</th>
                                        <th>Staff</th>
                                        <th>Amount</th>
                                        <th>Type</th>
                                        <th>Requested</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingPayments.map(p => `
                                        <tr>
                                            <td>${p.refNumber}</td>
                                            <td>${p.staffName}</td>
                                            <td>‚Ç¶${p.amount.toLocaleString()}</td>
                                            <td>${p.paymentMethod}</td>
                                            <td>${new Date(p.requestDate).toLocaleDateString()}</td>
                                            <td>
                                            <button class="action-btn"
        onclick="app.viewConceptNoteDetails('${p.conceptNoteRef}')"
        style="min-width:150px;margin-bottom:8px;border-color:var(--primary);color:var(--primary);">
        üìÑ View Concept Note
    </button><br>
                                                ${p.beneficiaryFileUrl ? `
                                                    <button class="action-btn" onclick="app.downloadFile('${p.beneficiaryFileUrl}', '${p.beneficiaryFileName}')">
                                                        üìé Download Beneficiaries
                                                    </button><br>
                                                ` : ''}
                                                <button class="action-btn approve" onclick="app.processPayment('${p.refNumber}')">
                                                    ‚úì Process Payment
                                                </button>
                                                <button class="action-btn reject" onclick="app.rejectPayment('${p.refNumber}')">
                                                    ‚úó Reject
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                    
                    ${pendingRetirements.length > 0 ? `
                        <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Retirement Submissions (${pendingRetirements.length})</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref</th>
                                        <th>Staff</th>
                                        <th>Payment Ref</th>
                                        <th>Spent</th>
                                        <th>Returned</th>
                                        <th>Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingRetirements.map(r => `
                                        <tr>
                                            <td>${r.refNumber}</td>
                                            <td>${r.staffName}</td>
                                            <td>${r.paymentRef}</td>
                                            <td>‚Ç¶${r.actualSpent.toLocaleString()}</td>
                                            <td>‚Ç¶${r.amountReturned.toLocaleString()}</td>
                                            <td>${new Date(r.submittedDate).toLocaleDateString()}</td>
                                            <td>
    ${r.receiptFileUrl ? `
        <button class="action-btn"
            onclick="app.downloadFile('${r.receiptFileUrl}', '${r.receiptFileName}')"
            style="min-width:150px;margin-bottom:8px;border-color:var(--primary);color:var(--primary);">
            üìé Download Receipt
        </button><br>
    ` : ''}

    <button class="action-btn approve"
        onclick="app.approveRetirement('${r.refNumber}')">
        ‚úì Approve Retirement
    </button>

    <button class="action-btn reject"
        onclick="app.rejectRetirement('${r.refNumber}')">
        ‚úó Reject
    </button>
</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                `;
            },
            
           async approveConceptNote(refNumber, action) {

    const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
    if (!cn) return;

    let updates = {};
    let autoCreatePayment = false;

    switch(action) {

        case 'approve_under_1m':

            if (cn.requiresProcurement === 'yes') {

                updates = {
                    currentApprover: 'procurement',
                    sentToProcurement: new Date().toISOString(),
                    retirementresponsibility: 'procurement'
                };

            } else {

                updates = {
                    status: 'approved',
                    approvedDate: new Date().toISOString(),
                    approvedBy: this.currentUser,
                    retirementresponsibility: 'staff'
                };

                autoCreatePayment = true;
            }

            break;


        case 'forward_to_ed':

            updates = {
                currentApprover: 'ed',
                forwardedToED: new Date().toISOString()
            };

            break;


        case 'ed_approve':

            if (cn.requiresProcurement === 'yes') {

                updates = {
                    currentApprover: 'procurement',
                    sentToProcurement: new Date().toISOString(),
                    retirementresponsibility: 'procurement'
                };

            } else {

                updates = {
                    status: 'approved',
                    approvedDate: new Date().toISOString(),
                    approvedBy: this.currentUser,
                    retirementresponsibility: 'staff'
                };

                autoCreatePayment = true;
            }

            break;
    }

    try {

        // 1Ô∏è‚É£ Update concept note first
        const { error } = await supabaseClient
            .from('concept_notes')
            .update(updates)
            .eq('refNumber', refNumber);

        if (error) throw error;


        // 2Ô∏è‚É£ If approval is final and no procurement ‚Üí create payment
        if (autoCreatePayment) {

            // Optional protection: prevent duplicate payment
            const { data: existingPayment } = await supabaseClient
                .from('payments')
                .select('id')
                .eq('conceptNoteRef', cn.refNumber)
                .maybeSingle();

            if (!existingPayment) {

                const { error: payError } = await supabaseClient
                    .from('payments')
                    .insert([{
                        refNumber: 'PAY' + Date.now(),
                        conceptNoteId: cn.id,
                        conceptNoteRef: cn.refNumber,
                        projectCode: cn.projectCode,
                        staffName: cn.staffName,
                        amount: cn.estimatedCost,
                        status: 'pending',
                        requestDate: new Date().toISOString(),
                        paymentMethod: 'bank_transfer',
                        retirementresponsibility: 'staff'
                    }]);

                if (payError) throw payError;
            }
        }

        Object.assign(cn, updates);
        this.clearCache();

        alert('Concept note processed successfully!');
        await this.loadData();
        this.showView('approvals');

    } catch (error) {

        console.error('Approval error:', error);
        alert('Error processing concept note: ' + error.message);
    }
                },
            
            async rejectConceptNote(refNumber) {
                const reason = prompt('Please provide a reason for rejection:');
                if (!reason) return;
                
                try {
                    const { error } = await supabaseClient
                        .from('concept_notes')
                        .update({
                            status: 'rejected',
                            rejectedDate: new Date().toISOString(),
                            rejectedBy: this.currentUser,
                            rejectionReason: reason
                        })
                        .eq('refNumber', refNumber);
                    
                    if (error) throw error;
                    
                    await this.loadData();
                    alert('Concept note rejected.');
                    this.showView('approvals');
                } catch (error) {
                    console.error('Reject error:', error);
                    alert('Error rejecting concept note: ' + error.message);
                }
            },
            
            showProcurementUpload(refNumber) {
                const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
                if (!cn) return;
                
                const content = document.getElementById('mainContent');
                content.innerHTML = `
                    <div class="header">
                        <h2>Complete Procurement & Forward to Finance</h2>
                        <p>Upload documents and create payment request</p>
                    </div>
                    
                    <form class="form-grid" id="procurementForm" onsubmit="app.completeProcurementWithDocs(event, '${refNumber}')">
                        <div class="form-group full-width">
                            <div class="threshold-info">
                                <strong>Concept Note:</strong> ${cn.refNumber} - ${cn.activityTitle}<br>
                                <strong>Amount:</strong> ‚Ç¶${cn.estimatedCost.toLocaleString()}<br>
                                <strong>Staff:</strong> ${cn.staffName}
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Upload GRR (Goods Received Report) <span class="required">*</span></label>
                            <div class="file-upload-area" id="grrUploadArea" onclick="document.getElementById('grrFile').click()">
                                <p>üìé Click to upload GRR document</p>
                                <span class="form-hint">PDF, JPG, PNG - Maximum 5MB</span>
                            </div>
                            <input type="file" id="grrFile" accept=".pdf,.jpg,.jpeg,.png" required style="display:none" onchange="app.handleFileUpload(this, 'grrUploadArea')">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Upload Purchase Order/Invoice <span class="required">*</span></label>
                            <div class="file-upload-area" id="poUploadArea" onclick="document.getElementById('poFile').click()">
                                <p>üìé Click to upload PO/Invoice</p>
                                <span class="form-hint">PDF, JPG, PNG - Maximum 5MB</span>
                            </div>
                            <input type="file" id="poFile" accept=".pdf,.jpg,.jpeg,.png" required style="display:none" onchange="app.handleFileUpload(this, 'poUploadArea')">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Procurement Notes</label>
                            <textarea id="procNotes" rows="3" placeholder="Additional information for Finance..."></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <h3 style="margin: 24px 0 16px; font-family: 'Archivo', sans-serif;">Staff Bank Account Details</h3>
                            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">Required for Finance to process payment</p>
                        </div>
                        
                        <div class="form-group">
                            <label>Account Name <span class="required">*</span></label>
                            <input type="text" id="accountName" required placeholder="Name as it appears on bank account">
                        </div>
                        
                        <div class="form-group">
                            <label>Account Number <span class="required">*</span></label>
                            <input type="text" id="accountNumber" required pattern="[0-9]{10}" maxlength="10" placeholder="10-digit account number">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Bank Name <span class="required">*</span></label>
                            <select id="bankName" required>
                                <option value="">Select Bank</option>
                                <option value="Access Bank">Access Bank</option>
                                <option value="Fidelity Bank">Fidelity Bank</option>
                                <option value="First Bank">First Bank</option>
                                <option value="FCMB">FCMB</option>
                                <option value="GTBank">GTBank</option>
                                <option value="Keystone Bank">Keystone Bank</option>
                                <option value="Polaris Bank">Polaris Bank</option>
                                <option value="Stanbic IBTC">Stanbic IBTC</option>
                                <option value="UBA">UBA</option>
                                <option value="Union Bank">Union Bank</option>
                                <option value="Unity Bank">Unity Bank</option>
                                <option value="Wema Bank">Wema Bank</option>
                                <option value="Zenith Bank">Zenith Bank</option>
                            </select>
                        </div>
                        
                        <div class="btn-group full-width">
                            <button type="submit" class="btn btn-primary" id="procurementSubmitBtn">
                                Complete & Send to Finance
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="app.showView('approvals')">
                                Cancel
                            </button>
                        </div>
                    </form>
                `;
            },
            
            handleFileUpload(input, areaId) {
                const area = document.getElementById(areaId);
                const file = input.files[0];
                
                if (file) {
                    // Validate size
                    if (file.size > MAX_FILE_SIZE) {
                        alert(`File too large! Maximum size is ${MAX_FILE_SIZE / 1024 / 1024}MB`);
                        input.value = '';
                        return;
                    }
                    
                    area.classList.add('has-file');
                    area.innerHTML = `
                        <p>‚úì ${file.name}</p>
                        <span class="form-hint">${(file.size / 1024).toFixed(1)} KB</span>
                    `;
                }
            },
            handleRetirementUpload(input) {
    const area = document.getElementById('retirementUploadArea');
    const file = input.files[0];

    if (file) {

        // Check file size
        if (file.size > MAX_FILE_SIZE) {
            alert(`File too large! Maximum size is ${MAX_FILE_SIZE / 1024 / 1024}MB`);
            input.value = '';
            return;
        }

        // Update UI
        area.classList.add('has-file');
        area.innerHTML = `
            <p>‚úì ${file.name}</p>
            <span class="form-hint">${(file.size / 1024).toFixed(1)} KB</span>
        `;
    }
}
            ,

            async completeProcurementWithDocs(event, refNumber) {
                event.preventDefault();
                
                const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
                if (!cn) return;
                
                const submitBtn = document.getElementById('procurementSubmitBtn');
                const grrFile = document.getElementById('grrFile').files[0];
                const poFile = document.getElementById('poFile').files[0];
                const notes = document.getElementById('procNotes').value;
                const accountName = document.getElementById('accountName').value;
                const accountNumber = document.getElementById('accountNumber').value;
                const bankName = document.getElementById('bankName').value;
                
                if (!grrFile || !poFile) {
                    alert('Please upload both GRR and PO/Invoice documents');
                    return;
                }
                
                if (!accountName || !accountNumber || !bankName) {
                    alert('Please provide all bank account details');
                    return;
                }
                
                if (!this.validateAccountNumber(accountNumber)) {
                    alert('Account number must be exactly 10 digits');
                    return;
                }
                
                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Uploading documents...';
                    
                    // Upload files to Supabase Storage
                    const grrData = await this.uploadFile(grrFile, 'grr');
                    submitBtn.textContent = 'Processing...';
                    const poData = await this.uploadFile(poFile, 'po');
                    
                    // Update concept note
                    const { error: cnError } = await supabaseClient
                        .from('concept_notes')
                        .update({
                            status: 'approved',
                            approvedDate: new Date().toISOString(),
                            approvedBy: this.currentUser,
                            procurementComplete: new Date().toISOString(),
                            retirementresponsibility: 'procurement',
                            grrFileUrl: grrData.url,
                            grrFileName: grrData.fileName,
                            poFileUrl: poData.url,
                            poFileName: poData.fileName,
                            procurementNotes: notes
                        })
                        .eq('refNumber', refNumber);
                    
                    if (cnError) throw cnError;
                    
                    // AUTO-CREATE PAYMENT REQUEST for Finance
                    const payment = {
                        refNumber: 'PAY' + Date.now(),
                        conceptNoteId: cn.id,
                        conceptNoteRef: cn.refNumber,
                        projectCode: cn.projectCode,
                        staffName: cn.staffName,
                        amount: cn.estimatedCost,
                        paymentMethod: 'bank_transfer',
                        justification: `Procurement completed by ${this.currentUser}. ${notes}`,
                        accountName: accountName,
                        accountNumber: accountNumber,
                        bankName: bankName,
                        status: 'pending',
                        requestDate: new Date().toISOString(),
                        procurementComplete: true,
                        retirementresponsibility: 'procurement'
                    };
                    
                    const { error: payError } = await supabaseClient
                        .from('payments')
                        .insert([payment])
                        .select();
                    
                    if (payError) throw payError;
                    
                    alert('Procurement completed and payment request sent to Finance!');
                    await this.loadData();
                    this.showView('approvals');
                    
                } catch (error) {
                    console.error('Procurement error:', error);
                    alert('Error: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Complete & Send to Finance';
                }
            },
        
            async processPayment(refNumber) {
                const payment = this.data.payments.find(p => p.refNumber === refNumber);
                if (!payment) return;
                
              // If beneficiary file exists ‚Üí batch payment (no bank confirmation needed)
if (payment.beneficiaryFileUrl) {

    if (!confirm(`Process batch payment of ‚Ç¶${payment.amount.toLocaleString()}?\n\nBeneficiary file attached.\n\nConfirm payment?`)) {
        return;
    }

} else {

    // Single payment must have bank details
    if (!payment.accountName || !payment.accountNumber || !payment.bankName) {
        alert('Error: Account details not provided by staff member.');
        return;
    }

    if (!confirm(`Process payment of ‚Ç¶${payment.amount.toLocaleString()} to:\n\nAccount Name: ${payment.accountName}\nAccount Number: ${payment.accountNumber}\nBank: ${payment.bankName}\n\nConfirm payment?`)) {
        return;
    }
}
                
                try {
                    const conceptNote = this.data.conceptNotes.find(cn => cn.refNumber === payment.conceptNoteRef);
                    
                    const { error } = await supabaseClient
                        .from('payments')
                        .update({
                            status: 'paid',
                            paidDate: new Date().toISOString(),
                            processedBy: this.currentUser,
                            retirementresponsibility: conceptNote?.retirementresponsibility || 'staff'
                        })
                        .eq('refNumber', refNumber);
                    
                    if (error) throw error;
                    
                    alert(`Payment of ‚Ç¶${payment.amount.toLocaleString()} processed successfully!`);
                    await this.loadData();
                    this.showView('approvals');
                } catch (error) {
                    console.error('Payment error:', error);
                    alert('Error processing payment: ' + error.message);
                }
            },

            viewConceptNoteDetails(refNumber) {
                const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
               if (!cn) {
    alert('Concept note not loaded. Refreshing data...');
    this.loadData().then(() => {
        const retry = this.data.conceptNotes.find(c => c.refNumber === refNumber);
        if (retry) app.viewConceptNoteDetails(refNumber);
        else alert('Concept note not found.');
    });
    return;
}
                
                const content = document.getElementById('mainContent');
                content.innerHTML = `
                    <div class="header">
                        <h2>Concept Note Details</h2>
                        <p>Full information for ${cn.refNumber}</p>
                    </div>
                    
                    <div class="form-grid two-col">
                        <div class="form-group">
                            <label>Reference Number</label>
                            <input type="text" value="${cn.refNumber}" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Status</label>
                            <span class="status-badge status-${cn.status}">${cn.status}</span>
                        </div>
                        
                        <div class="form-group">
                            <label>Staff Name</label>
                            <input type="text" value="${cn.staffName}" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Submitted Date</label>
                            <input type="text" value="${new Date(cn.submittedDate).toLocaleString()}" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Project Code</label>
                            <input type="text" value="${cn.projectCode}" readonly>
                        </div>
                        
                        <div class="form-group">
                            <label>Estimated Cost</label>
                            <input type="text" value="‚Ç¶${cn.estimatedCost.toLocaleString()}" readonly>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Activity Title</label>
                            <input type="text" value="${cn.activityTitle}" readonly>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Objective</label>
                            <textarea rows="3" readonly>${cn.objective}</textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Description</label>
                            <textarea rows="4" readonly>${cn.description}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Requires Procurement?</label>
                            <input type="text" value="${cn.requiresProcurement === 'yes' ? 'Yes' : 'No'}" readonly>
                        </div>
                        
                        ${cn.procurementNotes ? `
                            <div class="form-group full-width">
                                <label>Procurement Notes</label>
                                <textarea rows="2" readonly>${cn.procurementNotes}</textarea>
                            </div>
                        ` : ''}
                        
                        ${cn.grrFileName ? `
                            <div class="form-group">
                                <label>GRR Document</label>
                                <button type="button" class="btn btn-secondary" onclick="app.downloadFile('${cn.grrFileUrl}', '${cn.grrFileName}')">
                                    üìé Download ${cn.grrFileName}
                                </button>
                            </div>
                        ` : ''}
                        
                        ${cn.poFileName ? `
                            <div class="form-group">
                                <label>PO/Invoice Document</label>
                                <button type="button" class="btn btn-secondary" onclick="app.downloadFile('${cn.poFileUrl}', '${cn.poFileName}')">
                                    üìé Download ${cn.poFileName}
                                </button>
                            </div>
                        ` : ''}
                        
                        <div class="btn-group full-width">
    <button class="btn btn-primary" onclick="app.showView('approvals')">
        ‚Üê Back to Approvals
    </button>

    <button class="btn btn-secondary"
        onclick="app.downloadConceptNoteFile('${cn.refNumber}')">
        ‚¨á Download Concept Note
    </button>
</div>
                    </div>
                `;
            },
            
            async rejectPayment(refNumber) {
                const reason = prompt('Please provide a reason for rejection:');
                if (!reason) return;
                
                try {
                    const { error } = await supabaseClient
                        .from('payments')
                        .update({
                            status: 'rejected',
                            rejectedDate: new Date().toISOString(),
                            rejectedBy: this.currentUser,
                            rejectionReason: reason
                        })
                        .eq('refNumber', refNumber);
                    
                    if (error) throw error;
                    
                    alert('Payment rejected.');
                    await this.loadData();
                    this.showView('approvals');
                } catch (error) {
                    console.error('Reject error:', error);
                    alert('Error rejecting payment: ' + error.message);
                }
            },
            
            async approveRetirement(refNumber) {
                try {
                    const { error } = await supabaseClient
                        .from('retirements')
                        .update({
                            status: 'approved',
                            approvedDate: new Date().toISOString(),
                            approvedBy: this.currentUser
                        })
                        .eq('refNumber', refNumber);
                    
                    if (error) throw error;
                    
                    alert('Retirement approved successfully!');
                    await this.loadData();
                    this.showView('approvals');
                } catch (error) {
                    console.error('Approval error:', error);
                    alert('Error approving retirement: ' + error.message);
                }
            },
            
            async rejectRetirement(refNumber) {
                const reason = prompt('Please provide a reason for rejection:');
                if (!reason) return;
                
                try {
                    const { error } = await supabaseClient
                        .from('retirements')
                        .update({
                            status: 'rejected',
                            rejectedDate: new Date().toISOString(),
                            rejectedBy: this.currentUser,
                            rejectionReason: reason
                        })
                        .eq('refNumber', refNumber);
                    
                    if (error) throw error;
                    
                    alert('Retirement rejected.');
                    await this.loadData();
                    this.showView('approvals');
                } catch (error) {
                    console.error('Reject error:', error);
                    alert('Error rejecting retirement: ' + error.message);
                }
            },
            
            renderReports(content) {
                const role = this.getUserRole();
                
                if (!['budgetOwner','ed','procurement','finance'].includes(role)) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <h3>Access Denied</h3>
                            <p>You don't have permission to view reports.</p>
                        </div>
                    `;
                    return;
                }
                
                const projectStats = this.data.projects.map(project => {
                    const spent = this.getProjectSpent(project.code);
                    const remaining = project.budget - spent;
                    const percentUsed = (spent / project.budget * 100).toFixed(1);
                    
                    return {
                        ...project,
                        spent,
                        remaining,
                        percentUsed
                    };
                });
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Reports & Budget Tracking</h2>
                        <p>Financial overview and budget utilization</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Budget</h3>
                            <div class="stat-value">‚Ç¶${this.data.projects.reduce((sum, p) => sum + p.budget, 0).toLocaleString()}</div>
                            <div class="stat-label">Across all projects</div>
                        </div>
                        <div class="stat-card warning">
                            <h3>Total Spent</h3>
                            <div class="stat-value">‚Ç¶${this.data.payments.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.amount, 0).toLocaleString()}</div>
                            <div class="stat-label">All paid requests</div>
                        </div>
                        <div class="stat-card">
                            <h3>Pending Approvals</h3>
                            <div class="stat-value">${this.data.conceptNotes.filter(cn => cn.status === 'pending').length}</div>
                            <div class="stat-label">Concept notes awaiting review</div>
                        </div>
                        <div class="stat-card danger">
                            <h3>Unretired Advances</h3>
                            <div class="stat-value">${this.data.payments.filter(p => p.status === 'paid' && !this.data.retirements.find(r => r.paymentRef === p.refNumber)).length}</div>
                            <div class="stat-label">Need retirement</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Project Budget Status</h3>
                    <div style="margin-bottom:16px;">
    <button class="btn btn-primary" onclick="app.exportPaymentsReport()">
        ‚¨á Download Payments Report
    </button>
</div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Project Code</th>
                                    <th>Project Name</th>
                                    <th>Total Budget</th>
                                    <th>Spent</th>
                                    <th>Remaining</th>
                                    <th>Usage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${projectStats.map(p => `
                                    <tr>
                                        <td><strong>${p.code}</strong></td>
                                        <td>${p.name}</td>
                                        <td>‚Ç¶${p.budget.toLocaleString()}</td>
                                        <td>‚Ç¶${p.spent.toLocaleString()}</td>
                                        <td>‚Ç¶${p.remaining.toLocaleString()}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div class="budget-bar" style="flex: 1; margin: 0;">
                                                    <div class="budget-fill ${p.percentUsed > 90 ? 'danger' : p.percentUsed > 70 ? 'warning' : ''}" 
                                                         style="width: ${p.percentUsed}%"></div>
                                                </div>
                                                <span style="font-weight: 600; min-width: 50px;">${p.percentUsed}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            renderSettings(content) {
                content.innerHTML = `
                    <div class="header">
                        <h2>Settings</h2>
                        <p>System configuration and user preferences</p>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <h3 style="margin-bottom: 16px;">User Information</h3>
                            <p><strong>Name:</strong> ${this.currentUser}</p>
                            <p><strong>Role:</strong> ${this.getUserRole() === 'staff' ? 'Staff Member' : this.getUserRole().toUpperCase()}</p>
                            <p style="margin-top: 16px; padding: 16px; background: var(--bg); border-radius: 8px; font-size: 13px;">
                                <strong>üí° Quick Tip:</strong> Your role determines what you can see and approve in the system. Contact your administrator if you need role changes.
                            </p>
                        </div>
                        
                        <div class="form-group full-width">
                            <h3 style="margin-bottom: 16px;">System Information</h3>
                            <p><strong>Version:</strong> 2.0.0 (Optimized)</p>
                            <p><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</p>
                            <p><strong>Storage:</strong> Supabase Cloud Storage</p>
                            <p><strong>Database:</strong> PostgreSQL with Row Level Security</p>
                        </div>
                        
                        <div class="form-group full-width">
                            <h3 style="margin-bottom: 16px;">Need Help?</h3>
                            <div style="background: var(--bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
                                <p style="margin-bottom: 16px; font-size: 14px;">For technical support or questions about the system:</p>
                                <ul style="list-style: none; padding: 0; margin: 0;">
                                    <li style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                                        <strong>Finance Questions:</strong> Contact Finance Team
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                                        <strong>Approval Issues:</strong> Contact Budget Owner
                                    </li>
                                    <li style="padding: 8px 0; border-bottom: 1px solid var(--border);">
                                        <strong>Technical Support:</strong> Contact IT Support
                                    </li>
                                    <li style="padding: 8px 0;">
                                        <strong>System Administrator:</strong> Aisha Linatu Abdulrahman
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <h3 style="margin-bottom: 16px;">Keyboard Shortcuts</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                <div style="background: var(--bg); padding: 12px; border-radius: 8px; font-size: 13px;">
                                    <kbd style="background: white; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); font-family: monospace;">Alt + D</kbd>
                                    <span style="margin-left: 8px;">Dashboard</span>
                                </div>
                                <div style="background: var(--bg); padding: 12px; border-radius: 8px; font-size: 13px;">
                                    <kbd style="background: white; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); font-family: monospace;">Alt + C</kbd>
                                    <span style="margin-left: 8px;">Create Concept Note</span>
                                </div>
                                <div style="background: var(--bg); padding: 12px; border-radius: 8px; font-size: 13px;">
                                    <kbd style="background: white; padding: 4px 8px; border-radius: 4px; border: 1px solid var(--border); font-family: monospace;">Alt + A</kbd>
                                    <span style="margin-left: 8px;">My Approvals</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="btn-group full-width">
                            <button class="btn btn-primary" onclick="app.showView('dashboard')">Back to Dashboard</button>
                            <button class="btn btn-secondary" onclick="app.logout()">Logout</button>
                        </div>
                    </div>
                `;
            },
            exportPaymentsReport() {
    const payments = this.data.payments;

    if (!payments.length) {
        alert('No payments available to export.');
        return;
    }

    // CSV headers
    let csv = [
        [
            'Reference',
            'Concept Note',
            'Project Code',
            'Staff Name',
            'Amount',
            'Status',
            'Request Date',
            'Paid Date',
            'Processed By'
        ].join(',')
    ];

    // Rows
    payments.forEach(p => {
        csv.push([
            p.refNumber || '',
            p.conceptNoteRef || '',
            p.projectCode || '',
            p.staffName || '',
            p.amount || 0,
            p.status || '',
            p.requestDate ? new Date(p.requestDate).toLocaleDateString() : '',
            p.paidDate ? new Date(p.paidDate).toLocaleDateString() : '',
            p.processedBy || ''
        ].join(','));
    });

    // Create file
    const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = 'rahama_payments_report.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    window.URL.revokeObjectURL(url);
},
            downloadConceptNoteFile(refNumber) {
    const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
    if (!cn) {
        alert('Concept note not found.');
        return;
    }

    const content = `
RAHAMA GIRL CHILD & WOMEN EMPOWERMENT INITIATIVE
------------------------------------------------

CONCEPT NOTE RECORD

Reference Number: ${cn.refNumber}
Staff Name: ${cn.staffName}
Project Code: ${cn.projectCode}
Estimated Cost: ‚Ç¶${cn.estimatedCost.toLocaleString()}
Submitted Date: ${new Date(cn.submittedDate).toLocaleString()}
Status: ${cn.status}

Activity Title:
${cn.activityTitle}

Objective:
${cn.objective}

Description:
${cn.description}

Requires Procurement:
${cn.requiresProcurement === 'yes' ? 'Yes' : 'No'}
`;

    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `${cn.refNumber}_Concept_Note.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    window.URL.revokeObjectURL(url);
},
            logout() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('pms_user');
                    window.location.href = 'https://rahamaorg.github.io/appraisal-system/';
                } 
            }
        };
        
        // Initialize app when page loads
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.altKey) {
                    switch(e.key.toLowerCase()) {
                        case 'd':
                            e.preventDefault();
                            app.showView('dashboard');
                            break;
                        case 'c':
                            e.preventDefault();
                            app.showView('conceptNote');
                            break;
                        case 'a':
                            e.preventDefault();
                            app.showView('approvals');
                            break;
                        case 'p':
                            e.preventDefault();
                            app.showView('payment');
                            break;
                        case 'r':
                            e.preventDefault();
                            app.showView('retirement');
                            break;
                    }
                }
            });
        });
    </script>
</body>
</html>

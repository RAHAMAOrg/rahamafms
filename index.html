<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rahama Financial Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Archivo:wght@600;700&display=swap');
        
        :root {
            --primary: #00796B;
            --primary-dark: #004D40;
            --primary-light: #4DB6AC;
            --accent: #FF6F00;
            --danger: #D32F2F;
            --warning: #F57C00;
            --success: #388E3C;
            --bg: #F5F7FA;
            --surface: #FFFFFF;
            --text: #1A1A1A;
            --text-muted: #616161;
            --border: #E0E0E0;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        .app {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }
        downloadFile(url, name) {
    if (!url) {
        alert('File not found.');
        return;
    }

    window.open(url, '_blank');
}
        async uploadFile(file, folder = 'general') {
    const fileName = `${folder}/${Date.now()}_${file.name}`;

    const { error } = await supabaseClient.storage
        .from(STORAGE_BUCKET)
        .upload(fileName, file);

    if (error) {
        alert('Upload failed: ' + error.message);
        return null;
    }

    const { data } = supabaseClient.storage
        .from(STORAGE_BUCKET)
        .getPublicUrl(fileName);

    return {
        url: data.publicUrl,
        fileName: file.name
    },
                                  downloadFile(url, name) {
    if (!url) {
        alert('File not found.');
        return;
    }

    window.open(url, '_blank');
};
}
        
        /* Sidebar */
        .sidebar {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            box-shadow: var(--shadow);
        }
        
        .logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }
        
        .logo h1 {
            font-family: 'Archivo', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .logo p {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .user-info {
            padding: 16px 24px;
            background: var(--bg);
            margin: 0 16px 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .user-info label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .user-info select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: var(--surface);
        }
        
        .nav {
            list-style: none;
        }
        
        .nav button {
            width: 100%;
            padding: 12px 24px;
            text-align: left;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text);
            transition: all 0.2s;
            position: relative;
        }
        
        .nav button:hover {
            background: var(--bg);
            color: var(--primary);
        }
        
        .nav button.active {
            background: linear-gradient(90deg, rgba(0,121,107,0.1) 0%, transparent 100%);
            color: var(--primary);
            font-weight: 600;
        }
        
        .nav button.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
        }
        
        .portal-link {
            margin: 24px 16px 0;
            padding: 12px;
            background: var(--primary);
            color: white;
            text-align: center;
            border-radius: 8px;
            text-decoration: none;
            display: block;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .portal-link:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Main content */
        .main {
            padding: 32px 48px;
            max-width: 1400px;
        }
        
        .header {
            margin-bottom: 32px;
        }
        
        .header h2 {
            font-family: 'Archivo', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .header p {
            color: var(--text-muted);
            font-size: 14px;
        }
        
        /* Alert badges */
        .alert-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 24px;
        }
        
        .alert-badge.warning {
            background: #FFF3E0;
            color: var(--warning);
            border: 1px solid #FFE0B2;
        }
        
        .alert-badge.danger {
            background: #FFEBEE;
            color: var(--danger);
            border: 1px solid #FFCDD2;
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            gap: 20px;
            background: var(--surface);
            padding: 32px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .form-grid.two-col {
            grid-template-columns: 1fr 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group label .required {
            color: var(--danger);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--surface);
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,121,107,0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            font-style: italic;
        }
        
        .threshold-info {
            padding: 16px;
            background: #E8F5E9;
            border: 1px solid #C8E6C9;
            border-radius: 8px;
            font-size: 13px;
            color: var(--success);
            font-weight: 500;
        }
        
        .threshold-info.high {
            background: #FFF3E0;
            border-color: #FFE0B2;
            color: var(--warning);
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Tables */
        .table-container {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--bg);
        }
        
        th {
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        
        td {
            padding: 16px;
            border-top: 1px solid var(--border);
            font-size: 14px;
        }
        
        tr:hover {
            background: var(--bg);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background: #FFF3E0;
            color: var(--warning);
        }
        
        .status-approved {
            background: #E8F5E9;
            color: var(--success);
        }
        
        .status-paid {
            background: #E3F2FD;
            color: #1976D2;
        }
        
        .status-retired {
            background: #F3E5F5;
            color: #7B1FA2;
        }
        
        .status-rejected {
            background: #FFEBEE;
            color: var(--danger);
        }
        
        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .stat-card h3 {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'Archivo', sans-serif;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .stat-card.danger .stat-value {
            color: var(--danger);
        }
        
        .stat-card.warning .stat-value {
            color: var(--warning);
        }
        
        .stat-card.success .stat-value {
            color: var(--success);
        }
        
        /* Budget bars */
        .budget-bar {
            margin-top: 12px;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .budget-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
        
        .budget-fill.warning {
            background: var(--warning);
        }
        
        .budget-fill.danger {
            background: var(--danger);
        }
        
        /* Action buttons in table */
        .action-btn {
            padding: 6px 12px;
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
        }
        
        .action-btn:hover {
            background: var(--bg);
        }
        
        .action-btn.approve {
            border-color: var(--success);
            color: var(--success);
        }
        
        .action-btn.approve:hover {
            background: var(--success);
            color: white;
        }
        
        .action-btn.reject {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .action-btn.reject:hover {
            background: var(--danger);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-muted);
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .workflow-diagram {
            background: var(--surface);
            padding: 32px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 32px;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
        }
        
        .workflow-number {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .workflow-content {
            flex: 1;
        }
        
        .workflow-content strong {
            display: block;
            margin-bottom: 4px;
            color: var(--text);
        }
        
        .workflow-content span {
            font-size: 13px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar">
            <div class="logo">
                <h1>Rahama FMS</h1>
                <p>Financial Management System</p>
            </div>
           <div class="user-info">
    <label>Signed in as</label>
    <div id="loggedInUser" style="font-weight:600;"></div>
</div>
            
            <ul class="nav">
                <li><button onclick="app.showView('dashboard')" class="active">Dashboard</button></li>
                <li><button onclick="app.showView('conceptNote')">Create Concept Note</button></li>
                <li><button onclick="app.showView('payment')">Request Payment</button></li>
                <li><button onclick="app.showView('retirement')">Submit Retirement</button></li>
                <li><button onclick="app.showView('approvals')">My Approvals</button></li>
                <li><button id="reportsBtn" onclick="app.showView('reports')">Reports & Budget</button></li>
                <li><button onclick="app.showView('settings')">Settings</button></li>
            </ul>
            
            <a href="https://rahamaorg.github.io/appraisal-system/" class="portal-link" target="_blank">
                ‚Üê Back to Staff Portal
            </a>
        </div>
        
        <div class="main" id="mainContent">
            <!-- Dynamic content loads here -->
        </div>
    </div>
    
    <script>
        const SUPABASE_URL = 'https://sqygmoxpegbfxddglhbx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxeWdtb3hwZWdiZnhkZGdsaGJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTYzNTcsImV4cCI6MjA4NjU3MjM1N30.Oi3Vhw4q4F58cyb1yhJ90fcjGIVNwp34CqMtfxswkr8';
const STORAGE_BUCKET = 'fms-documents';

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const app = {
    currentUser: '',
    data: {
        conceptNotes: [],
        payments: [],
        retirements: [],

        staff: [
            'Usman Musa',
            'Aisha Linatu Abdulrahman',
            'Fatima Yusuf Matsayi',
            'Khadijah Abdulrahman',
            'Sani Hamisu',
            'Salahuddeen Sambo',
            'Ahmad Abdulrahman Tijjani',
            'Maryam Abdulrahman Tijjani',
            'Sumayya Adam',
            'Aisha Umar',
            'Paulina Paul',
            'Fatima Tijjani'
        ],

        projects: [
            { code: 'DRT102', name: 'Ascent Phase II', budget: 35000000 },
            { code: 'CBA101', name: 'Community Health Initiative', budget: 16000000 },
            { code: 'GEPP101', name: 'Girls Education & Protection Program GEPP', budget: 75000000 },
            { code: 'AYP101', name: 'Adolescents and Young People Project', budget: 8000000 },
            { code: 'TES101', name: 'TES', budget: 500000 },
            { code: 'ADM001', name: 'Admin & Operations', budget: 1000000 }
        ],

        roles: {
            'Aisha Linatu Abdulrahman': 'budgetOwner',
            'Fatima Tijjani': 'ed',
            'Fatima Yusuf Matsayi': 'procurement',
            'Musa Usman': 'procurement',
            'Salahuddeen Ahmad': 'finance',
            'Sani Hamisu': 'finance'
        }
    },
init() {
    this.loadData();

    // ALWAYS try URL first
    const params = new URLSearchParams(window.location.search);
    const urlSession = params.get('session');

    if (urlSession) {
    localStorage.setItem('pms_user', decodeURIComponent(urlSession));
}

    const session = localStorage.getItem('pms_user');

    if (session) {
    const user = JSON.parse(session);
    this.currentUser = user.name;

    const el = document.getElementById('loggedInUser');
    if (el) el.innerText = user.name;

    /* ===== HIDE REPORTS IF NOT AUTHORIZED ===== */
    const role = this.getUserRole();
    const btn = document.getElementById('reportsBtn');

    if (!['budgetOwner','ed','procurement','finance'].includes(role)) {
        if (btn) btn.style.display = 'none';
    }
    /* ========================================== */
}

this.showView('dashboard');
},
            
            loadData() {
                const saved = localStorage.getItem('fms_data');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    this.data.conceptNotes = parsed.conceptNotes || [];
                    this.data.payments = parsed.payments || [];
                    this.data.retirements = parsed.retirements || [];
                }
            },
            
            saveData() {
                localStorage.setItem('fms_data', JSON.stringify({
                    conceptNotes: this.data.conceptNotes,
                    payments: this.data.payments,
                    retirements: this.data.retirements
                }));
            },
            
            showView(viewName) {
             // Update active nav safely
document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));

if (typeof event !== 'undefined' && event?.target) {
    event.target.classList.add('active');
}
                const content = document.getElementById('mainContent');
                
                if (!this.currentUser) {
    content.innerHTML = `
        <div class="empty-state">
            <h2>User session not found</h2>
            <p>Please login from the Staff Portal.</p>
        </div>
    `;
    return;
}
                
                switch(viewName) {
                    case 'dashboard': this.renderDashboard(content); break;
                    case 'conceptNote': this.renderConceptNoteForm(content); break;
                    case 'payment': this.renderPaymentForm(content); break;
                    case 'retirement': this.renderRetirementForm(content); break;
                    case 'approvals': this.renderApprovals(content); break;
                    case 'reports': this.renderReports(content); break;
                    case 'settings': this.renderSettings(content); break;
                }
            },
            
            renderDashboard(content) {
                const myConceptNotes = this.data.conceptNotes.filter(cn => cn.staffName === this.currentUser);
                const myPayments = this.data.payments.filter(p => p.staffName === this.currentUser);
                const myRetirements = this.data.retirements.filter(r => r.staffName === this.currentUser);
                
                const unretiredPayments = myPayments.filter(p => 
                    p.status === 'paid' && !this.data.retirements.find(r => r.paymentRef === p.refNumber)
                );
                
                const overdueRetirements = unretiredPayments.filter(p => {
                    const daysSince = Math.floor((Date.now() - new Date(p.paidDate)) / (1000 * 60 * 60 * 24));
                    return daysSince > 10;
                });
                
                const isLocked = unretiredPayments.length >= 2 || overdueRetirements.length > 0;
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Dashboard</h2>
                        <p>Welcome back, ${this.currentUser.split(' ')[0]}</p>
                    </div>
                    
                    ${isLocked ? `
                        <div class="alert-badge danger">
                            ‚ö†Ô∏è Your account is locked: ${unretiredPayments.length >= 2 ? 
                                `${unretiredPayments.length} unretired advances` : 
                                `Retirement overdue by ${Math.floor((Date.now() - new Date(overdueRetirements[0].paidDate)) / (1000 * 60 * 60 * 24))} days`}
                        </div>
                    ` : ''}
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Concept Notes</h3>
                            <div class="stat-value">${myConceptNotes.length}</div>
                            <div class="stat-label">Total submitted</div>
                        </div>
                        <div class="stat-card ${unretiredPayments.length > 0 ? 'warning' : 'success'}">
                            <h3>Unretired Advances</h3>
                            <div class="stat-value">${unretiredPayments.length}</div>
                            <div class="stat-label">${unretiredPayments.length >= 2 ? 'Account locked!' : 'Active advances'}</div>
                        </div>
                        <div class="stat-card ${overdueRetirements.length > 0 ? 'danger' : ''}">
                            <h3>Overdue Retirements</h3>
                            <div class="stat-value">${overdueRetirements.length}</div>
                            <div class="stat-label">${overdueRetirements.length > 0 ? 'Action required!' : 'All current'}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Paid</h3>
                            <div class="stat-value">‚Ç¶${myPayments.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.amount, 0).toLocaleString()}</div>
                            <div class="stat-label">Lifetime payments</div>
                        </div>
                    </div>
                    
                    <div class="workflow-diagram">
                        <h3 style="margin-bottom: 20px; font-family: 'Archivo', sans-serif;">Financial Workflow</h3>
                        <div class="workflow-step">
                            <div class="workflow-number">1</div>
                            <div class="workflow-content">
                                <strong>Staff creates Concept Note/ToR</strong>
                                <span>Submitted to Budget Owner for review</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">2</div>
                            <div class="workflow-content">
                                <strong>Budget Owner Review</strong>
                                <span>Approves if ‚â§‚Ç¶1M, forwards to ED if >‚Ç¶1M, routes to Procurement if items needed</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">3</div>
                            <div class="workflow-content">
                                <strong>Procurement (if needed)</strong>
                                <span>Procures items, attaches GRR + evidence, pushes to Finance</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">4</div>
                            <div class="workflow-content">
                                <strong>Finance processes payment</strong>
                                <span>Reviews documents, makes payment, shares confirmation</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">5</div>
                            <div class="workflow-content">
                                <strong>Staff submits retirement</strong>
                                <span>Within 10 days of payment receipt</span>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Recent Activity</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Reference</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.getRecentActivity().map(item => `
                                    <tr>
                                        <td>${new Date(item.date).toLocaleDateString()}</td>
                                        <td>${item.type}</td>
                                        <td>${item.ref}</td>
                                        <td>${item.amount ? '‚Ç¶' + item.amount.toLocaleString() : '-'}</td>
                                        <td><span class="status-badge status-${item.status}">${item.status}</span></td>
                                    </tr>
                                `).join('') || '<tr><td colspan="5" style="text-align: center; padding: 32px; color: #999;">No recent activity</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            getRecentActivity() {
                const activity = [];
                
                this.data.conceptNotes.filter(cn => cn.staffName === this.currentUser).forEach(cn => {
                    activity.push({
                        date: cn.submittedDate,
                        type: 'Concept Note',
                        ref: cn.refNumber,
                        amount: cn.estimatedCost,
                        status: cn.status
                    });
                });
                
                this.data.payments.filter(p => p.staffName === this.currentUser).forEach(p => {
                    activity.push({
                        date: p.requestDate,
                        type: 'Payment',
                        ref: p.refNumber,
                        amount: p.amount,
                        status: p.status
                    });
                });
                
                this.data.retirements.filter(r => r.staffName === this.currentUser).forEach(r => {
                    activity.push({
                        date: r.submittedDate,
                        type: 'Retirement',
                        ref: r.refNumber,
                        amount: r.actualSpent,
                        status: r.status
                    });
                });
                
                return activity.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            },
            
            renderConceptNoteForm(content) {
                content.innerHTML = `
                    <div class="header">
                        <h2>Create Concept Note</h2>
                        <p>Step 1: Develop your concept note or Terms of Reference</p>
                    </div>
                    
                    <form class="form-grid two-col" onsubmit="app.submitConceptNote(event)">
                        <div class="form-group">
                            <label>Project Code <span class="required">*</span></label>
                            <select name="projectCode" required onchange="app.updateProjectBudget(this.value)">
                                <option value="">Select project</option>
                                ${this.data.projects.map(p => `
                                    <option value="${p.code}">${p.code} - ${p.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Activity Title <span class="required">*</span></label>
                            <input type="text" name="activityTitle" required placeholder="e.g., Radio Jingle Production - Kano">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Objective <span class="required">*</span></label>
                            <textarea name="objective" required placeholder="What is the purpose of this activity?"></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Description <span class="required">*</span></label>
                            <textarea name="description" required placeholder="Detailed description of the activity"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Estimated Cost (‚Ç¶) <span class="required">*</span></label>
                            <input type="number" name="estimatedCost" required min="1" onchange="app.checkThreshold(this.value)">
                            <span class="form-hint">Enter amount in Naira</span>
                        </div>
                        
                        <div class="form-group">
                            <label>Requires Procurement? <span class="required">*</span></label>
                            <select name="requiresProcurement" required>
                                <option value="no">No - Direct service/payment</option>
                                <option value="yes">Yes - Items need to be procured</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width" id="thresholdInfo"></div>
                        
                        <div class="btn-group full-width">
                            <button type="submit" class="btn btn-primary">Submit Concept Note</button>
                            <button type="button" class="btn btn-secondary" onclick="app.showView('dashboard')">Cancel</button>
                        </div>
                    </form>
                `;
            },
            
            checkThreshold(amount) {
                const info = document.getElementById('thresholdInfo');
                if (!amount || amount <= 0) {
                    info.innerHTML = '';
                    return;
                }
                
                const num = parseFloat(amount);
                if (num <= 1000000) {
                    info.innerHTML = `
                        <div class="threshold-info">
                            ‚úì Budget Owner approval required (Amount ‚â§ ‚Ç¶1,000,000)
                        </div>
                    `;
                } else {
                    info.innerHTML = `
                        <div class="threshold-info high">
                            ‚ö†Ô∏è Executive Director approval required (Amount > ‚Ç¶1,000,000)
                        </div>
                    `;
                }
            },
            
            submitConceptNote(e) {
                e.preventDefault();
                const form = e.target;
                const data = new FormData(form);
                
                const cn = {
                    refNumber: this.generateRefNumber('CN'),
                    staffName: this.currentUser,
                    projectCode: data.get('projectCode'),
                    activityTitle: data.get('activityTitle'),
                    objective: data.get('objective'),
                    description: data.get('description'),
                    estimatedCost: parseFloat(data.get('estimatedCost')),
                    requiresProcurement: data.get('requiresProcurement'),
                    status: 'pending_budget_owner',
                    submittedDate: new Date().toISOString(),
                    approvalHistory: []
                };
                
                this.data.conceptNotes.push(cn);
                this.saveData();
                
                alert(`Concept Note ${cn.refNumber} submitted successfully!\nSent to Budget Owner for review.`);
                this.showView('dashboard');
            },
            
            generateRefNumber(type) {
                const date = new Date();
                const year = date.getFullYear();
                const count = this.data.conceptNotes.length + this.data.payments.length + this.data.retirements.length + 1;
                const num = count.toString().padStart(3, '0');
                
                return `${type}-${year}-${num}`;
            },
            
            renderPaymentForm(content) {
                const approvedCNs = this.data.conceptNotes.filter(cn => 
                    cn.staffName === this.currentUser && 
                    (cn.status === 'approved' || cn.status === 'procurement_complete')
                );
                
                const unretiredPayments = this.data.payments.filter(p => 
                    p.staffName === this.currentUser &&
                    p.status === 'paid' && 
                    !this.data.retirements.find(r => r.paymentRef === p.refNumber)
                );
                
                const overdueRetirements = unretiredPayments.filter(p => {
                    const daysSince = Math.floor((Date.now() - new Date(p.paidDate)) / (1000 * 60 * 60 * 24));
                    return daysSince > 10;
                });
                
                const isLocked = unretiredPayments.length >= 2 || overdueRetirements.length > 0;
                
                if (isLocked) {
                    content.innerHTML = `
                        <div class="header">
                            <h2>Request Payment</h2>
                            <p>Payment requests are currently locked</p>
                        </div>
                        
                        <div class="alert-badge danger">
                            üîí Account Locked - You cannot request new payments
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <p style="margin-bottom: 16px;"><strong>Reason for lock:</strong></p>
                                ${unretiredPayments.length >= 2 ? `
                                    <p>You have ${unretiredPayments.length} unretired advances. Maximum allowed is 2.</p>
                                ` : ''}
                                ${overdueRetirements.length > 0 ? `
                                    <p>You have retirements overdue by more than 10 days.</p>
                                    <ul style="margin-top: 8px;">
                                        ${overdueRetirements.map(p => `
                                            <li>${p.refNumber}: ${Math.floor((Date.now() - new Date(p.paidDate)) / (1000 * 60 * 60 * 24))} days overdue</li>
                                        `).join('')}
                                    </ul>
                                ` : ''}
                                <p style="margin-top: 16px;"><strong>Action required:</strong> Please submit retirement forms for your outstanding advances.</p>
                            </div>
                            <div class="btn-group full-width">
                                <button class="btn btn-primary" onclick="app.showView('retirement')">Submit Retirement</button>
                                <button class="btn btn-secondary" onclick="app.showView('dashboard')">Back to Dashboard</button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                if (approvedCNs.length === 0) {
                    content.innerHTML = `
                        <div class="header">
                            <h2>Request Payment</h2>
                            <p>No approved concept notes available</p>
                        </div>
                        
                        <div class="empty-state">
                            <p>You need an approved concept note before requesting payment.</p>
                            <button class="btn btn-primary" onclick="app.showView('conceptNote')" style="margin-top: 16px;">Create Concept Note</button>
                        </div>
                    `;
                    return;
                }
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Request Payment</h2>
                        <p>Step 2: Request payment for approved activity</p>
                    </div>
                    
                    <form class="form-grid two-col" onsubmit="app.submitPayment(event)">
                        <div class="form-group full-width">
                            <label>Select Approved Concept Note <span class="required">*</span></label>
                            <select name="conceptNoteRef" required onchange="app.loadConceptNoteDetails(this.value)">
                                <option value="">Choose concept note</option>
                                ${approvedCNs.map(cn => `
                                    <option value="${cn.refNumber}">
                                        ${cn.refNumber} - ${cn.activityTitle} (‚Ç¶${cn.estimatedCost.toLocaleString()})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div id="cnDetails"></div>
                        
                        <div class="form-group">
                            <label>Payment Amount (‚Ç¶) <span class="required">*</span></label>
                            <input type="number" name="amount" required min="1" id="paymentAmount">
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Method <span class="required">*</span></label>
                            <select name="paymentMethod" required>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="cash">Cash</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Justification <span class="required">*</span></label>
                            <textarea name="justification" required placeholder="Provide details on how this amount will be used"></textarea>
                        </div>
                        
                        <div class="btn-group full-width">
                            <button type="submit" class="btn btn-primary">Submit Payment Request</button>
                            <button type="button" class="btn btn-secondary" onclick="app.showView('dashboard')">Cancel</button>
                        </div>
                    </form>
                `;
            },
            
            loadConceptNoteDetails(refNumber) {
                const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
                if (!cn) return;
                
                const details = document.getElementById('cnDetails');
                details.className = 'form-group full-width';
                details.innerHTML = `
                    <div style="background: #F5F7FA; padding: 16px; border-radius: 8px; border: 1px solid #E0E0E0;">
                        <p><strong>Activity:</strong> ${cn.activityTitle}</p>
                        <p style="margin-top: 8px;"><strong>Project:</strong> ${cn.projectCode}</p>
                        <p style="margin-top: 8px;"><strong>Estimated Cost:</strong> ‚Ç¶${cn.estimatedCost.toLocaleString()}</p>
                        <p style="margin-top: 8px;"><strong>Status:</strong> <span class="status-badge status-${cn.status}">${cn.status.replace(/_/g, ' ')}</span></p>
                    </div>
                `;
                
                document.getElementById('paymentAmount').value = cn.estimatedCost;
            },
            
            submitPayment(e) {
                e.preventDefault();
                const form = e.target;
                const data = new FormData(form);
                
                const payment = {
                    refNumber: this.generateRefNumber('PR'),
                    conceptNoteRef: data.get('conceptNoteRef'),
                    staffName: this.currentUser,
                    amount: parseFloat(data.get('amount')),
                    paymentMethod: data.get('paymentMethod'),
                    justification: data.get('justification'),
                    status: 'pending_finance',
                    requestDate: new Date().toISOString()
                };
                
                this.data.payments.push(payment);
                this.saveData();
                
                alert(`Payment request ${payment.refNumber} submitted successfully!\nSent to Finance for processing.`);
                this.showView('dashboard');
            },
            
            renderRetirementForm(content) {
                const paidPayments = this.data.payments.filter(p => 
                    p.staffName === this.currentUser && 
                    p.status === 'paid' &&
                    !this.data.retirements.find(r => r.paymentRef === p.refNumber)
                );
                
                if (paidPayments.length === 0) {
                    content.innerHTML = `
                        <div class="header">
                            <h2>Submit Retirement</h2>
                            <p>No payments available for retirement</p>
                        </div>
                        
                        <div class="empty-state">
                            <p>You don't have any paid advances that need retirement.</p>
                            <button class="btn btn-secondary" onclick="app.showView('dashboard')" style="margin-top: 16px;">Back to Dashboard</button>
                        </div>
                    `;
                    return;
                }
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Submit Retirement</h2>
                        <p>Step 3: Retire your advance within 10 days of payment</p>
                    </div>
                    
                    <form class="form-grid two-col" onsubmit="app.submitRetirement(event)">
                        <div class="form-group full-width">
                            <label>Select Payment to Retire <span class="required">*</span></label>
                            <select name="paymentRef" required onchange="app.loadPaymentDetails(this.value)">
                                <option value="">Choose payment</option>
                                ${paidPayments.map(p => {
                                    const daysSince = Math.floor((Date.now() - new Date(p.paidDate)) / (1000 * 60 * 60 * 24));
                                    const overdue = daysSince > 10;
                                    return `
                                        <option value="${p.refNumber}" ${overdue ? 'style="color: #D32F2F; font-weight: 600;"' : ''}>
                                            ${p.refNumber} - ‚Ç¶${p.amount.toLocaleString()} ${overdue ? `(${daysSince} days overdue!)` : `(${daysSince} days ago)`}
                                        </option>
                                    `;
                                }).join('')}
                            </select>
                        </div>
                        
                        <div id="paymentDetails"></div>
                        
                        <div class="form-group">
                            <label>Actual Amount Spent (‚Ç¶) <span class="required">*</span></label>
                            <input type="number" name="actualSpent" required min="0" id="actualSpent">
                        </div>
                        
                        <div class="form-group">
                            <label>Balance to Return (‚Ç¶)</label>
                            <input type="number" id="balance" readonly style="background: #F5F7FA;">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Activity Report <span class="required">*</span></label>
                            <textarea name="activityReport" required placeholder="Describe how the funds were used and outcomes achieved"></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Supporting Documents</label>
                            <input type="text" name="supportingDocs" placeholder="List receipts, invoices, photos, etc.">
                            <span class="form-hint">Attach evidence of expenditure</span>
                        </div>
                        
                        <div class="btn-group full-width">
                            <button type="submit" class="btn btn-primary">Submit Retirement</button>
                            <button type="button" class="btn btn-secondary" onclick="app.showView('dashboard')">Cancel</button>
                        </div>
                    </form>
                `;
                
                // Add listener to calculate balance
                setTimeout(() => {
                    const actualSpent = document.getElementById('actualSpent');
                    if (actualSpent) {
                        actualSpent.addEventListener('input', function() {
                            const paymentRef = document.querySelector('[name="paymentRef"]').value;
                            if (!paymentRef) return;
                            
                            const payment = app.data.payments.find(p => p.refNumber === paymentRef);
                            if (!payment) return;
                            
                            const spent = parseFloat(this.value) || 0;
                            const balance = payment.amount - spent;
                            document.getElementById('balance').value = balance.toFixed(2);
                        });
                    }
                }, 100);
            },
            
            loadPaymentDetails(refNumber) {
                const payment = this.data.payments.find(p => p.refNumber === refNumber);
                if (!payment) return;
                
                const daysSince = Math.floor((Date.now() - new Date(payment.paidDate)) / (1000 * 60 * 60 * 24));
                const overdue = daysSince > 10;
                
                const details = document.getElementById('paymentDetails');
                details.className = 'form-group full-width';
                details.innerHTML = `
                    <div style="background: ${overdue ? '#FFEBEE' : '#F5F7FA'}; padding: 16px; border-radius: 8px; border: 1px solid ${overdue ? '#FFCDD2' : '#E0E0E0'};">
                        <p><strong>Payment Reference:</strong> ${payment.refNumber}</p>
                        <p style="margin-top: 8px;"><strong>Amount Received:</strong> ‚Ç¶${payment.amount.toLocaleString()}</p>
                        <p style="margin-top: 8px;"><strong>Paid Date:</strong> ${new Date(payment.paidDate).toLocaleDateString()}</p>
                        <p style="margin-top: 8px;"><strong>Days Since Payment:</strong> ${daysSince} days ${overdue ? '‚ö†Ô∏è OVERDUE' : ''}</p>
                        ${overdue ? '<p style="margin-top: 8px; color: #D32F2F; font-weight: 600;">Retirement is overdue! Please submit immediately.</p>' : ''}
                    </div>
                `;
                
                document.getElementById('actualSpent').value = payment.amount;
                document.getElementById('actualSpent').dispatchEvent(new Event('input'));
            },
            
            submitRetirement(e) {
                e.preventDefault();
                const form = e.target;
                const data = new FormData(form);
                
                const retirement = {
                    refNumber: this.generateRefNumber('RT'),
                    paymentRef: data.get('paymentRef'),
                    staffName: this.currentUser,
                    actualSpent: parseFloat(data.get('actualSpent')),
                    balanceToReturn: parseFloat(document.getElementById('balance').value),
                    activityReport: data.get('activityReport'),
                    supportingDocs: data.get('supportingDocs'),
                    status: 'completed',
                    submittedDate: new Date().toISOString()
                };
                
                this.data.retirements.push(retirement);
                this.saveData();
                
                alert(`Retirement ${retirement.refNumber} submitted successfully!`);
                this.showView('dashboard');
            },
            
            renderApprovals(content) {
                const userRole = this.getUserRole();
                
                if (!userRole) {
                    content.innerHTML = `
                        <div class="header">
                            <h2>My Approvals</h2>
                            <p>You do not have approval authority</p>
                        </div>
                        <div class="empty-state">
                            <p>This section is only available for Budget Owners, ED, Procurement, and Finance staff.</p>
                        </div>
                    `;
                    return;
                }
                
                const pendingItems = this.getPendingApprovals(userRole);
                
                content.innerHTML = `
                    <div class="header">
                        <h2>My Approvals</h2>
                        <p>Items pending your review as ${this.getRoleName(userRole)}</p>
                    </div>
                    
                    ${pendingItems.length === 0 ? `
                        <div class="empty-state">
                            <p>No items pending your approval</p>
                        </div>
                    ` : `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Reference</th>
                                        <th>Staff</th>
                                        <th>Amount</th>
                                        <th>Details</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingItems.map(item => `
                                        <tr>
                                            <td>${new Date(item.date).toLocaleDateString()}</td>
                                            <td>${item.type}</td>
                                            <td>${item.ref}</td>
                                            <td>${item.staff}</td>
                                            <td>‚Ç¶${item.amount.toLocaleString()}</td>
                                            <td>${item.details}</td>
                                            <td>
                                                ${this.getApprovalButtons(item, userRole)}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                `;
            },
            
            getUserRole() {
                const userName = this.currentUser.split(' (')[0]; // Remove role suffix if present
                return this.data.roles[userName] || this.data.roles[this.currentUser];
            },
            
            getRoleName(role) {
                const names = {
                    budgetOwner: 'Budget Owner',
                    ed: 'Executive Director',
                    procurement: 'Procurement Officer',
                    finance: 'Finance Officer'
                };
                return names[role] || role;
            },
            
            getProjectSpent(projectCode) {
                return this.data.payments
                    .filter(p => {
                        // Find the linked concept note
                        const cn = this.data.conceptNotes.find(c => c.id === p.conceptNoteId);
                        // Check if concept note exists, matches project, and payment is paid
                        return cn && cn.projectCode === projectCode && p.status === 'paid';
                    })
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
            },
            
            updateProjectBudget(projectCode) {
                const project = this.data.projects.find(p => p.code === projectCode);
                const infoDiv = document.getElementById('budgetInfo');
                
                if (project && infoDiv) {
                    const spent = this.getProjectSpent(projectCode);
                    const remaining = project.budget - spent;
                    const percentUsed = (spent / project.budget * 100).toFixed(1);
                    
                    infoDiv.innerHTML = `
                        <strong>Budget Status:</strong> ‚Ç¶${remaining.toLocaleString()} remaining 
                        (${percentUsed}% used of ‚Ç¶${project.budget.toLocaleString()})
                    `;
                    
                    if (percentUsed > 80) {
                        infoDiv.className = 'threshold-info high';
                    } else {
                        infoDiv.className = 'threshold-info';
                    }
                    
                    infoDiv.style.display = 'block';
                }
            },
            
            getPendingApprovals(userRole) {
                const items = [];
                
                // Concept notes pending approval
                if (userRole === 'budgetOwner') {
                    this.data.conceptNotes.filter(cn => cn.status === 'pending_budget_owner').forEach(cn => {
                        items.push({
                            type: 'Concept Note',
                            ref: cn.refNumber,
                            date: cn.submittedDate,
                            staff: cn.staffName,
                            amount: cn.estimatedCost,
                            details: cn.activityTitle,
                            item: cn,
                            itemType: 'conceptNote'
                        });
                    });
                }
                
                if (userRole === 'ed') {
                    this.data.conceptNotes.filter(cn => cn.status === 'pending_ed').forEach(cn => {
                        items.push({
                            type: 'Concept Note',
                            ref: cn.refNumber,
                            date: cn.submittedDate,
                            staff: cn.staffName,
                            amount: cn.estimatedCost,
                            details: cn.activityTitle,
                            item: cn,
                            itemType: 'conceptNote'
                        });
                    });
                }
                
                if (userRole === 'procurement') {
                    this.data.conceptNotes.filter(cn => cn.status === 'pending_procurement').forEach(cn => {
                        items.push({
                            type: 'Procurement Request',
                            ref: cn.refNumber,
                            date: cn.submittedDate,
                            staff: cn.staffName,
                            amount: cn.estimatedCost,
                            details: cn.activityTitle,
                            item: cn,
                            itemType: 'procurement'
                        });
                    });
                }
                
                if (userRole === 'finance') {
                    this.data.payments.filter(p => p.status === 'pending_finance').forEach(p => {
                        items.push({
                            type: 'Payment Request',
                            ref: p.refNumber,
                            date: p.requestDate,
                            staff: p.staffName,
                            amount: p.amount,
                            details: p.justification,
                            item: p,
                            itemType: 'payment'
                        });
                    });
                }
                
                return items;
            },
            
          getApprovalButtons(item, userRole) {

    // ===== BUDGET OWNER =====
    if (userRole === 'budgetOwner' && item.itemType === 'conceptNote') {
        const needsED = item.amount > 1000000;

        return `
            ${item.item.requiresProcurement === 'yes' ? 
                `<button class="action-btn" onclick="app.routeToProcurement('${item.ref}')">
                    ‚Üí Route to Procurement
                </button>` : 
                `<button class="action-btn approve" onclick="app.approveConceptNote('${item.ref}', ${needsED})">
                    ‚úì Approve${needsED ? ' & Forward to ED' : ''}
                </button>`
            }
            <button class="action-btn reject" onclick="app.rejectItem('${item.ref}', 'conceptNote')">
                ‚úó Reject
            </button>
        `;
    }

    // ===== ED =====
    if (userRole === 'ed' && item.itemType === 'conceptNote') {
        return `
            <button class="action-btn approve" onclick="app.approveByED('${item.ref}')">‚úì Approve</button>
            <button class="action-btn reject" onclick="app.rejectItem('${item.ref}', 'conceptNote')">‚úó Reject</button>
        `;
    }

    // ===== PROCUREMENT =====
    if (userRole === 'procurement' && item.itemType === 'procurement') {
    return `
        <button class="action-btn approve" onclick="app.showProcurementUpload('${item.ref}')">
            Upload Docs & Send to Finance
        </button>
    `;
}
    // ===== FINANCE =====
    if (userRole === 'finance' && item.itemType === 'payment') {
        return `
            <button class="action-btn approve" onclick="app.processPayment('${item.ref}')">
                ‚úì Process Payment
            </button>
            <button class="action-btn reject" onclick="app.rejectItem('${item.ref}', 'payment')">
                ‚úó Reject
            </button>
        `;
    }

   return '';
},
            
            approveConceptNote(refNumber, needsED) {
                const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
                if (!cn) return;
                
                cn.approvalHistory.push({
                    approver: this.currentUser,
                    role: 'Budget Owner',
                    action: 'approved',
                    date: new Date().toISOString()
                });
                
                if (needsED) {
                    cn.status = 'pending_ed';
                    alert(`${refNumber} approved and forwarded to Executive Director (amount > ‚Ç¶1,000,000)`);
                } else {
                    cn.status = 'approved';
                    alert(`${refNumber} approved! Staff can now request payment.`);
                }
                
                this.saveData();
                this.renderApprovals(document.getElementById('mainContent'));
            },
            
            routeToProcurement(refNumber) {
    const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
    if (!cn) return;

    const comment = prompt('Add approval comment for procurement:');
    if (!comment) {
        alert('Comment is required.');
        return;
    }

    cn.approvalHistory.push({
        approver: this.currentUser,
        role: 'Budget Owner',
        action: 'routed_to_procurement',
        comment: comment,
        date: new Date().toISOString()
    });

    cn.status = 'pending_procurement';

    this.saveData();

    alert(`${refNumber} sent to Procurement successfully.`);
    
    this.renderApprovals(document.getElementById('mainContent'));
},
            
            approveByED(refNumber) {
                const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
                if (!cn) return;
                
                cn.approvalHistory.push({
                    approver: this.currentUser,
                    role: 'Executive Director',
                    action: 'approved',
                    date: new Date().toISOString()
                });
                
                if (cn.requiresProcurement === 'yes') {
                    cn.status = 'pending_procurement';
                    alert(`${refNumber} approved and sent to Procurement`);
                } else {
                    cn.status = 'approved';
                    alert(`${refNumber} approved! Staff can now request payment.`);
                }
                
                this.saveData();
                this.renderApprovals(document.getElementById('mainContent'));
            },
            
            completeProcurement(refNumber) {
                const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
                if (!cn) return;
                
                const evidence = prompt('Enter GRR reference and evidence details:');
                if (!evidence) return;
                
                cn.approvalHistory.push({
                    approver: this.currentUser,
                    role: 'Procurement Officer',
                    action: 'procurement_completed',
                    evidence: evidence,
                    date: new Date().toISOString()
                });
                
                cn.status = 'procurement_complete';
                alert(`${refNumber} procurement completed with evidence: ${evidence}\nSent to Finance for payment.`);
                
                this.saveData();
                this.renderApprovals(document.getElementById('mainContent'));
            },
            showProcurementUpload(refNumber) {
    const content = document.getElementById('mainContent');

    content.innerHTML = `
        <div class="header">
            <h2>Procurement Documentation</h2>
            <p>Attach GRR / invoice before sending to Finance</p>
        </div>

        <div class="form-grid">
            <div class="form-group full-width">
                <label>Upload Document</label>
                <input type="file" id="procFile" required />
            </div>

            <div class="form-group full-width">
                <label>Comment</label>
                <textarea id="procComment" placeholder="Optional note to finance"></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="app.completeProcurementWithFile('${refNumber}')">
                    Send to Finance
                </button>
                <button class="btn btn-secondary" onclick="app.showView('approvals')">
                    Cancel
                </button>
            </div>
        </div>
    `;
},
async completeProcurementWithFile(refNumber) {
    const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
    if (!cn) return;

    const fileInput = document.getElementById('procFile');
    if (!fileInput.files.length) {
        alert('Please upload a document.');
        return;
    }

    const comment = document.getElementById('procComment').value || '';

    const file = fileInput.files[0];
    const reader = new FileReader();

  const uploaded = await this.uploadFile(file, 'procurement');
if (!uploaded) return;
        cn.approvalHistory.push({
            approver: this.currentUser,
            role: 'Procurement Officer',
            action: 'procurement_completed',
            comment,
            fileName: file.name,
            fileUrl: uploaded.url,
fileName: uploaded.fileName,
            date: new Date().toISOString()
        });

        cn.status = 'procurement_complete';

        this.saveData();
        alert('Sent to Finance successfully.');
        this.showView('approvals');
    };

    reader.readAsDataURL(file);
},
            processPayment(refNumber) {
                const payment = this.data.payments.find(p => p.refNumber === refNumber);
                if (!payment) return;
                
                const confirm = window.confirm(`Process payment of ‚Ç¶${payment.amount.toLocaleString()} to ${payment.staffName}?`);
                if (!confirm) return;
                
                payment.status = 'paid';
                payment.paidDate = new Date().toISOString();
                payment.processedBy = this.currentUser;
                
                alert(`Payment ${refNumber} processed successfully!\nStaff has been notified to submit retirement within 10 days.`);
                
                this.saveData();
                this.renderApprovals(document.getElementById('mainContent'));
            },
            
            rejectItem(refNumber, type) {
                const reason = prompt('Enter rejection reason:');
                if (!reason) return;
                
                if (type === 'conceptNote') {
                    const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
                    if (cn) {
                        cn.status = 'rejected';
                        cn.rejectionReason = reason;
                        cn.rejectedBy = this.currentUser;
                        cn.rejectedDate = new Date().toISOString();
                    }
                } else if (type === 'payment') {
                    const payment = this.data.payments.find(p => p.refNumber === refNumber);
                    if (payment) {
                        payment.status = 'rejected';
                        payment.rejectionReason = reason;
                        payment.rejectedBy = this.currentUser;
                        payment.rejectedDate = new Date().toISOString();
                    }
                }
                
                alert(`${refNumber} rejected. Reason: ${reason}`);
                this.saveData();
                this.renderApprovals(document.getElementById('mainContent'));
            },
            
 renderReports(content) {

    const role = this.getUserRole();
    if (!['budgetOwner','ed','procurement','finance'].includes(role)) {
        content.innerHTML =
            '<div class="empty-state">' +
            '<h2>Access Denied</h2>' +
            '<p>You are not authorized to view financial reports.</p>' +
            '</div>';
        return;
    }

    const projectStats = this.data.projects.map(project => {
        const spent = this.getProjectSpent(project.code);
        const remaining = project.budget - spent;
        const percentUsed = (spent / project.budget * 100).toFixed(1);
        
        return {
            ...project,
            spent,
            remaining,
            percentUsed
        };
    });

    content.innerHTML = `
        <div class="header">
            <h2>Reports & Budget Tracking</h2>
            <p>Financial overview and budget utilization</p>
        </div>
        
        <div style="margin-bottom: 24px;">
            <button class="btn btn-primary" onclick="app.downloadBudgetReport()">
                üì• Download Budget Report (Excel)
            </button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Budget</h3>
                <div class="stat-value">‚Ç¶${this.data.projects.reduce((sum, p) => sum + p.budget, 0).toLocaleString()}</div>
                <div class="stat-label">Across all projects</div>
            </div>
            <div class="stat-card warning">
                <h3>Total Spent</h3>
                <div class="stat-value">‚Ç¶${this.data.payments.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.amount, 0).toLocaleString()}</div>
                <div class="stat-label">All paid requests</div>
            </div>
            <div class="stat-card">
                <h3>Pending Approvals</h3>
                <div class="stat-value">${this.data.conceptNotes.filter(cn => cn.status === 'pending').length}</div>
                <div class="stat-label">Concept notes awaiting review</div>
            </div>
            <div class="stat-card danger">
                <h3>Unretired Advances</h3>
                <div class="stat-value">${this.data.payments.filter(p => p.status === 'paid' && !this.data.retirements.find(r => r.paymentRef === p.refNumber)).length}</div>
                <div class="stat-label">Need retirement</div>
            </div>
        </div>
        
        <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Project Budget Status</h3>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Project Code</th>
                        <th>Project Name</th>
                        <th>Total Budget</th>
                        <th>Spent</th>
                        <th>Remaining</th>
                        <th>Usage</th>
                    </tr>
                </thead>
                <tbody>
                    ${projectStats.map(p => `
                        <tr>
                            <td><strong>${p.code}</strong></td>
                            <td>${p.name}</td>
                            <td>‚Ç¶${p.budget.toLocaleString()}</td>
                            <td>‚Ç¶${p.spent.toLocaleString()}</td>
                            <td>‚Ç¶${p.remaining.toLocaleString()}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="budget-bar" style="flex: 1; margin: 0;">
                                        <div class="budget-fill ${p.percentUsed > 90 ? 'danger' : p.percentUsed > 70 ? 'warning' : ''}" 
                                             style="width: ${p.percentUsed}%"></div>
                                    </div>
                                    <span style="font-weight: 600; min-width: 50px;">${p.percentUsed}%</span>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
},
            
            downloadBudgetReport() {
                // Create CSV content
                let csv = 'RAHAMA FMS - Budget Report\n';
                csv += 'Generated: ' + new Date().toLocaleString() + '\n\n';
                
                csv += 'PROJECT BUDGET SUMMARY\n';
                csv += 'Project Code,Project Name,Total Budget,Spent,Remaining,Percentage Used\n';
                
                this.data.projects.forEach(project => {
                    const spent = this.getProjectSpent(project.code);
                    const remaining = project.budget - spent;
                    const percentUsed = (spent / project.budget * 100).toFixed(1);
                    
                    csv += `${project.code},${project.name},${project.budget},${spent},${remaining},${percentUsed}%\n`;
                });
                
                csv += '\n\nDETAILED TRANSACTIONS BY PROJECT\n\n';
                
                this.data.projects.forEach(project => {
                    const projectPayments = this.data.payments.filter(p => {
                        const cn = this.data.conceptNotes.find(c => c.id === p.conceptNoteId);
                        return cn && cn.projectCode === project.code && p.status === 'paid';
                    });
                    
                    if (projectPayments.length > 0) {
                        csv += `\n${project.code} - ${project.name}\n`;
                        csv += 'Payment Ref,Staff,Amount,Date,Concept Note\n';
                        
                        projectPayments.forEach(p => {
                            const cn = this.data.conceptNotes.find(c => c.id === p.conceptNoteId);
                            csv += `${p.refNumber},${p.staffName},${p.amount},${new Date(p.paidDate).toLocaleDateString()},${cn ? cn.refNumber : 'N/A'}\n`;
                        });
                    }
                });
                
                // Download file
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `RAHAMA_Budget_Report_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
            
            
            calculateBudgetUtilization() {
                return this.data.projects.map(proj => {
                    const utilized = this.data.payments
                        .filter(p => {
                            const cn = this.data.conceptNotes.find(c => c.refNumber === p.conceptNoteRef);
                            return cn && cn.projectCode === proj.code && p.status === 'paid';
                        })
                        .reduce((sum, p) => sum + p.amount, 0);
                    
                    const remaining = proj.budget - utilized;
                    const percentage = Math.round((utilized / proj.budget) * 100);
                    
                    return {
                        code: proj.code,
                        name: proj.name,
                        budget: proj.budget,
                        utilized,
                        remaining,
                        percentage
                    };
                });
            },
            
            getRetirementRate() {
                const paid = this.data.payments.filter(p => p.status === 'paid').length;
                if (paid === 0) return 0;
                return Math.round((this.data.retirements.length / paid) * 100);
            },
            
            renderSettings(content) {
                content.innerHTML = `
                    <div class="header">
                        <h2>Settings</h2>
                        <p>System configuration and data management</p>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Data Management</h3>
                            <p style="margin-bottom: 16px; color: var(--text-muted);">
                                Export your financial data to CSV for reporting or backup purposes.
                            </p>
                            <button class="btn btn-primary" onclick="app.exportToCSV()">Export All Data to CSV</button>
                        </div>
                        
                        <div class="form-group full-width">
                            <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">System Information</h3>
                            <div style="background: #F5F7FA; padding: 16px; border-radius: 8px; border: 1px solid #E0E0E0;">
                                <p><strong>Version:</strong> 2.0</p>
                                <p style="margin-top: 8px;"><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</p>
                                <p style="margin-top: 8px;"><strong>Data Storage:</strong> Browser localStorage</p>
                                <p style="margin-top: 8px;"><strong>Active User:</strong> ${this.currentUser || 'None'}</p>
                            </div>
                        </div>
                        
                        <div class="form-group full-width">
                            <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif; color: var(--danger);">Danger Zone</h3>
                            <p style="margin-bottom: 16px; color: var(--text-muted);">
                                Caution: This action cannot be undone. Only use for testing or if you need to start fresh.
                            </p>
                            <button class="btn btn-secondary" style="border-color: var(--danger); color: var(--danger);" 
                                    onclick="app.clearAllData()">Clear All Data</button>
                        </div>
                    </div>
                `;
            },
            
            exportToCSV() {
                const csvData = [];
                
                // Export concept notes
                csvData.push('CONCEPT NOTES');
                csvData.push('Reference,Staff Name,Project Code,Activity Title,Estimated Cost,Status,Submitted Date,Requires Procurement');
                this.data.conceptNotes.forEach(cn => {
                    csvData.push(`${cn.refNumber},${cn.staffName},${cn.projectCode},"${cn.activityTitle}",${cn.estimatedCost},${cn.status},${cn.submittedDate},${cn.requiresProcurement}`);
                });
                csvData.push('');
                
                // Export payments
                csvData.push('PAYMENTS');
                csvData.push('Reference,Concept Note Ref,Staff Name,Amount,Payment Method,Status,Request Date,Paid Date');
                this.data.payments.forEach(p => {
                    csvData.push(`${p.refNumber},${p.conceptNoteRef},${p.staffName},${p.amount},${p.paymentMethod},${p.status},${p.requestDate},${p.paidDate || ''}`);
                });
                csvData.push('');
                
                // Export retirements
                csvData.push('RETIREMENTS');
                csvData.push('Reference,Payment Ref,Staff Name,Actual Spent,Balance to Return,Status,Submitted Date');
                this.data.retirements.forEach(r => {
                    csvData.push(`${r.refNumber},${r.paymentRef},${r.staffName},${r.actualSpent},${r.balanceToReturn},${r.status},${r.submittedDate}`);
                });
                
                // Create and download CSV
                const blob = new Blob([csvData.join('\n')], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `rahama-fms-export-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                alert('Data exported successfully!');
            },
            
            clearAllData() {
                const confirm = window.confirm('Are you sure you want to delete ALL data? This cannot be undone!');
                if (!confirm) return;
                
                const doubleConfirm = window.confirm('This will permanently delete all concept notes, payments, and retirements. Continue?');
                if (!doubleConfirm) return;
                
                localStorage.removeItem('fms_data');
                this.data.conceptNotes = [];
                this.data.payments = [];
                this.data.retirements = [];
                
                alert('All data cleared. The system has been reset.');
                this.showView('dashboard');
            }
        };
        
        // Initialize on page load
       window.addEventListener('DOMContentLoaded', () => {
    app.init();
});
    </script>
</body>
</html>

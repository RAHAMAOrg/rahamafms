<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rahama Financial Management System</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Archivo:wght@600;700&display=swap');
        
        :root {
            --primary: #00796B;
            --primary-dark: #004D40;
            --primary-light: #4DB6AC;
            --accent: #FF6F00;
            --danger: #D32F2F;
            --warning: #F57C00;
            --success: #388E3C;
            --bg: #F5F7FA;
            --surface: #FFFFFF;
            --text: #1A1A1A;
            --text-muted: #616161;
            --border: #E0E0E0;
            --shadow: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        .app {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--surface);
            border-right: 1px solid var(--border);
            padding: 24px 0;
            box-shadow: var(--shadow);
        }
        
        .logo {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 24px;
        }
        
        .logo h1 {
            font-family: 'Archivo', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 4px;
        }
        
        .logo p {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
        }
        
        .user-info {
            padding: 16px 24px;
            background: var(--bg);
            margin: 0 16px 24px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .user-info label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        
        .user-info select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            background: var(--surface);
        }
        
        .nav {
            list-style: none;
        }
        
        .nav button {
            width: 100%;
            padding: 12px 24px;
            text-align: left;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text);
            transition: all 0.2s;
            position: relative;
        }
        
        .nav button:hover {
            background: var(--bg);
            color: var(--primary);
        }
        
        .nav button.active {
            background: linear-gradient(90deg, rgba(0,121,107,0.1) 0%, transparent 100%);
            color: var(--primary);
            font-weight: 600;
        }
        
        .nav button.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
        }
        
        .portal-link {
            margin: 24px 16px 0;
            padding: 12px;
            background: var(--primary);
            color: white;
            text-align: center;
            border-radius: 8px;
            text-decoration: none;
            display: block;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .portal-link:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Main content */
        .main {
            padding: 32px 48px;
            max-width: 1400px;
        }
        
        .header {
            margin-bottom: 32px;
        }
        
        .header h2 {
            font-family: 'Archivo', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .header p {
            color: var(--text-muted);
            font-size: 14px;
        }
        
        /* Alert badges */
        .alert-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 24px;
        }
        
        .alert-badge.warning {
            background: #FFF3E0;
            color: var(--warning);
            border: 1px solid #FFE0B2;
        }
        
        .alert-badge.danger {
            background: #FFEBEE;
            color: var(--danger);
            border: 1px solid #FFCDD2;
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            gap: 20px;
            background: var(--surface);
            padding: 32px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .form-grid.two-col {
            grid-template-columns: 1fr 1fr;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
        }
        
        .form-group label .required {
            color: var(--danger);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            background: var(--surface);
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,121,107,0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-hint {
            font-size: 12px;
            color: var(--text-muted);
            font-style: italic;
        }
        
        .threshold-info {
            padding: 16px;
            background: #E8F5E9;
            border: 1px solid #C8E6C9;
            border-radius: 8px;
            font-size: 13px;
            color: var(--success);
            font-weight: 500;
        }
        
        .threshold-info.high {
            background: #FFF3E0;
            border-color: #FFE0B2;
            color: var(--warning);
        }
        
        /* Buttons */
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Tables */
        .table-container {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: var(--bg);
        }
        
        th {
            padding: 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        
        td {
            padding: 16px;
            border-top: 1px solid var(--border);
            font-size: 14px;
        }
        
        tr:hover {
            background: var(--bg);
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-pending {
            background: #FFF3E0;
            color: var(--warning);
        }
        
        .status-approved {
            background: #E8F5E9;
            color: var(--success);
        }
        
        .status-paid {
            background: #E3F2FD;
            color: #1976D2;
        }
        
        .status-retired {
            background: #F3E5F5;
            color: #7B1FA2;
        }
        
        .status-rejected {
            background: #FFEBEE;
            color: var(--danger);
        }
        
        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--surface);
            padding: 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        
        .stat-card h3 {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'Archivo', sans-serif;
            color: var(--text);
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .stat-card.danger .stat-value {
            color: var(--danger);
        }
        
        .stat-card.warning .stat-value {
            color: var(--warning);
        }
        
        .stat-card.success .stat-value {
            color: var(--success);
        }
        
        /* Budget bars */
        .budget-bar {
            margin-top: 12px;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .budget-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
        
        .budget-fill.warning {
            background: var(--warning);
        }
        
        .budget-fill.danger {
            background: var(--danger);
        }
        
        /* Action buttons in table */
        .action-btn {
            padding: 12px 18px;
            background: none;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
            min-width: 180px;
        }
        
        .action-btn:hover {
            background: var(--bg);
        }
        
        .action-btn.approve {
            border-color: var(--success);
            color: var(--success);
        }
        
        .action-btn.approve:hover {
            background: var(--success);
            color: white;
        }
        
        .action-btn.reject {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .action-btn.reject:hover {
            background: var(--danger);
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 64px 32px;
            color: var(--text-muted);
        }
        
        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .workflow-diagram {
            background: var(--surface);
            padding: 32px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 32px;
        }
        
        .workflow-step {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg);
            border-radius: 8px;
        }
        
        .workflow-number {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .workflow-content {
            flex: 1;
        }
        
        .workflow-content strong {
            display: block;
            margin-bottom: 4px;
            color: var(--text);
        }
        
        .workflow-content span {
            font-size: 13px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar">
            <div class="logo">
                <h1>Rahama FMS</h1>
                <p>Financial Management System</p>
            </div>
            <div class="user-info">
                <label>Signed in as</label>
                <div id="loggedInUser" style="font-weight:600;"></div>
            </div>
            
            <ul class="nav">
                <li><button onclick="app.showView('dashboard')" class="active" data-view="dashboard">Dashboard</button></li>
                <li><button onclick="app.showView('conceptNote')" data-view="conceptNote">Create Concept Note</button></li>
                <li><button onclick="app.showView('payment')" data-view="payment">Request Payment</button></li>
                <li><button onclick="app.showView('retirement')" data-view="retirement">Submit Retirement</button></li>
                <li><button onclick="app.showView('approvals')" data-view="approvals">My Approvals</button></li>
                <li><button id="reportsBtn" onclick="app.showView('reports')" data-view="reports">Reports & Budget</button></li>
                <li><button onclick="app.showView('settings')" data-view="settings">Settings</button></li>
            </ul>
            
            <a href="https://rahamaorg.github.io/appraisal-system/" class="portal-link" target="_blank">
                ← Back to Staff Portal
            </a>
        </div>
        
        <div class="main" id="mainContent">
            <!-- Dynamic content loads here -->
        </div>
    </div>
    
    <script>
        const SUPABASE_URL = "https://sqygmoxpegbfxddglhbx.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxeWdtb3hwZWdiZnhkZGdsaGJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5OTYzNTcsImV4cCI6MjA4NjU3MjM1N30.Oi3Vhw4q4F58cyb1yhJ90fcjGIVNwp34CqMtfxswkr8";

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const app = {
            currentUser: '',
            data: {
                conceptNotes: [],
                payments: [],
                retirements: [],

                staff: [
                    'Usman Musa',
                    'Aisha Linatu Abdulrahman',
                    'Fatima Yusuf Matsayi',
                    'Khadijah Abdulrahman',
                    'Sani Hamisu',
                    'Salahuddeen Sambo',
                    'Ahmad Abdulrahman Tijjani',
                    'Maryam Abdulrahman Tijjani',
                    'Sumayya Adam',
                    'Aisha Umar',
                    'Paulina Paul',
                    'Fatima Tijjani'
                ],

                projects: [
                    { code: 'DRT102', name: 'Ascent Phase II', budget: 35000000 },
                    { code: 'CBA101', name: 'Community Health Initiative', budget: 16000000 },
                    { code: 'GEPP101', name: 'Girls Education & Protection Program GEPP', budget: 75000000 },
                    { code: 'AYP101', name: 'Adolescents and Young People Project', budget: 8000000 },
                    { code: 'TES101', name: 'TES', budget: 500000 },
                    { code: 'ADM001', name: 'Admin & Operations', budget: 1000000 }
                ],

                roles: {
                    'Aisha Linatu Abdulrahman': 'budgetOwner',
                    'Fatima Tijjani': 'ed',
                    'Khadijah Abdulrahman': 'procurement',
                    'Fatima Yusuf Matsayi': 'procurement',
                    'Usman Musa': 'procurement',
                    'Salahuddeen Sambo': 'finance',
                    'Sani Hamisu': 'finance'
                }
            },
            
            async init() {
                await this.loadData();

                // URL takes priority
                const params = new URLSearchParams(window.location.search);
                const urlSession = params.get('session');

                if (urlSession) {
                    localStorage.setItem('pms_user', decodeURIComponent(urlSession));
                }

                const session = localStorage.getItem('pms_user');

                if (session) {
                    const user = JSON.parse(session);
                    this.currentUser = user.name;

                    const el = document.getElementById('loggedInUser');
                    if (el) el.innerText = user.name;

                    // Hide Reports if not authorized
                    const role = this.getUserRole();
                    const btn = document.getElementById('reportsBtn');

                    if (!['budgetOwner','ed','procurement','finance'].includes(role)) {
                        if (btn) btn.style.display = 'none';
                    }
                }

                this.showView('dashboard');
            },
            
            async loadData() {
                // Load concept notes
                const { data: cn, error: cnError } = await supabaseClient
                    .from('concept_notes')
                    .select('*');

                if (cnError) {
                    console.error('Concept note load error:', cnError);
                } else {
                    this.data.conceptNotes = cn || [];
                }

                // Load payments
                const { data: pay, error: payError } = await supabaseClient
                    .from('payments')
                    .select('*');

                if (payError) {
                    console.error('Payment load error:', payError);
                } else {
                    this.data.payments = pay || [];
                }

                // Load retirements - FIX #1
                const { data: ret, error: retError } = await supabaseClient
                    .from('retirements')
                    .select('*');

                if (retError) {
                    console.error('Retirement load error:', retError);
                } else {
                    this.data.retirements = ret || [];
                }
            },
            
            // FIX #2: Add getUserRole method
            getUserRole() {
                return this.data.roles[this.currentUser] || 'staff';
            },
            
            // FIX #3: Add updateProjectBudget method
            updateProjectBudget(projectCode) {
                const project = this.data.projects.find(p => p.code === projectCode);
                const infoDiv = document.getElementById('budgetInfo');
                
                if (project && infoDiv) {
                    const spent = this.getProjectSpent(projectCode);
                    const remaining = project.budget - spent;
                    const percentUsed = (spent / project.budget * 100).toFixed(1);
                    
                    infoDiv.innerHTML = `
                        <strong>Budget Status:</strong> ₦${remaining.toLocaleString()} remaining 
                        (${percentUsed}% used of ₦${project.budget.toLocaleString()})
                    `;
                    
                    if (percentUsed > 80) {
                        infoDiv.className = 'threshold-info high';
                    } else {
                        infoDiv.className = 'threshold-info';
                    }
                }
            },
            
            getProjectSpent(projectCode) {
                return this.data.payments
                    .filter(p => p.projectCode === projectCode && p.status === 'paid')
                    .reduce((sum, p) => sum + (p.amount || 0), 0);
            },
            
            showView(viewName) {
                // Update active nav safely
                document.querySelectorAll('.nav button').forEach(btn => btn.classList.remove('active'));
                
                // Find and activate the correct button by data attribute
                const targetBtn = document.querySelector(`.nav button[data-view="${viewName}"]`);
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
                
                const content = document.getElementById('mainContent');
                
                if (!this.currentUser) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <h2>User session not found</h2>
                            <p>Please login from the Staff Portal.</p>
                        </div>
                    `;
                    return;
                }
                
                switch(viewName) {
                    case 'dashboard': this.renderDashboard(content); break;
                    case 'conceptNote': this.renderConceptNoteForm(content); break;
                    case 'payment': this.renderPaymentForm(content); break;
                    case 'retirement': this.renderRetirementForm(content); break;
                    case 'approvals': this.renderApprovals(content); break;
                    case 'reports': this.renderReports(content); break;
                    case 'settings': this.renderSettings(content); break;
                }
            },
            
            renderDashboard(content) {
                const myConceptNotes = this.data.conceptNotes.filter(cn => cn.staffName === this.currentUser);
                const myPayments = this.data.payments.filter(p => p.staffName === this.currentUser);
                const myRetirements = this.data.retirements.filter(r => r.staffName === this.currentUser);
                
                const unretiredPayments = myPayments.filter(p => 
                    p.status === 'paid' && !this.data.retirements.find(r => r.paymentRef === p.refNumber)
                );
                
                // FIX #4: Add null check for paidDate
                const overdueRetirements = unretiredPayments.filter(p => {
                    if (!p.paidDate) return false;
                    const daysSince = Math.floor((Date.now() - new Date(p.paidDate)) / (1000 * 60 * 60 * 24));
                    return daysSince > 10;
                });
                
                const isLocked = unretiredPayments.length >= 2 || overdueRetirements.length > 0;
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Dashboard</h2>
                        <p>Welcome back, ${this.currentUser.split(' ')[0]}</p>
                    </div>
                    
                    ${isLocked ? `
                        <div class="alert-badge danger">
                            ⚠️ Your account is locked: ${unretiredPayments.length >= 2 ? 
                                `${unretiredPayments.length} unretired advances` : 
                                `Retirement overdue by ${Math.floor((Date.now() - new Date(overdueRetirements[0].paidDate)) / (1000 * 60 * 60 * 24))} days`}
                        </div>
                    ` : ''}
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Concept Notes</h3>
                            <div class="stat-value">${myConceptNotes.length}</div>
                            <div class="stat-label">Total submitted</div>
                        </div>
                        <div class="stat-card ${unretiredPayments.length > 0 ? 'warning' : 'success'}">
                            <h3>Unretired Advances</h3>
                            <div class="stat-value">${unretiredPayments.length}</div>
                            <div class="stat-label">${unretiredPayments.length >= 2 ? 'Account locked!' : 'Active advances'}</div>
                        </div>
                        <div class="stat-card ${overdueRetirements.length > 0 ? 'danger' : ''}">
                            <h3>Overdue Retirements</h3>
                            <div class="stat-value">${overdueRetirements.length}</div>
                            <div class="stat-label">${overdueRetirements.length > 0 ? 'Action required!' : 'All current'}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Paid</h3>
                            <div class="stat-value">₦${myPayments.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.amount, 0).toLocaleString()}</div>
                            <div class="stat-label">Lifetime payments</div>
                        </div>
                    </div>
                    
                    <div class="workflow-diagram">
                        <h3 style="margin-bottom: 20px; font-family: 'Archivo', sans-serif;">Financial Workflow</h3>
                        <div class="workflow-step">
                            <div class="workflow-number">1</div>
                            <div class="workflow-content">
                                <strong>Staff creates Concept Note/ToR</strong>
                                <span>Submitted to Budget Owner for review</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">2</div>
                            <div class="workflow-content">
                                <strong>Budget Owner Review</strong>
                                <span>Approves if ≤₦1M, forwards to ED if >₦1M, routes to Procurement if items needed</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">3</div>
                            <div class="workflow-content">
                                <strong>Procurement (if needed)</strong>
                                <span>Procures items, attaches GRR + evidence, pushes to Finance</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">4</div>
                            <div class="workflow-content">
                                <strong>Finance processes payment</strong>
                                <span>Reviews documents, makes payment, shares confirmation</span>
                            </div>
                        </div>
                        <div class="workflow-step">
                            <div class="workflow-number">5</div>
                            <div class="workflow-content">
                                <strong>Staff submits retirement</strong>
                                <span>Within 10 days of payment receipt</span>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Recent Activity</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Reference</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${this.getRecentActivity().map(item => `
                                    <tr>
                                        <td>${new Date(item.date).toLocaleDateString()}</td>
                                        <td>${item.type}</td>
                                        <td>${item.ref}</td>
                                        <td>${item.amount ? '₦' + item.amount.toLocaleString() : '-'}</td>
                                        <td><span class="status-badge status-${item.status}">${item.status}</span></td>
                                    </tr>
                                `).join('') || '<tr><td colspan="5" style="text-align: center; padding: 32px; color: #999;">No recent activity</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            getRecentActivity() {
                const activity = [];
                
                this.data.conceptNotes.filter(cn => cn.staffName === this.currentUser).forEach(cn => {
                    activity.push({
                        date: cn.submittedDate,
                        type: 'Concept Note',
                        ref: cn.refNumber,
                        amount: cn.estimatedCost,
                        status: cn.status
                    });
                });
                
                this.data.payments.filter(p => p.staffName === this.currentUser).forEach(p => {
                    activity.push({
                        date: p.requestDate,
                        type: 'Payment',
                        ref: p.refNumber,
                        amount: p.amount,
                        status: p.status
                    });
                });
                
                this.data.retirements.filter(r => r.staffName === this.currentUser).forEach(r => {
                    activity.push({
                        date: r.submittedDate,
                        type: 'Retirement',
                        ref: r.refNumber,
                        amount: r.actualSpent,
                        status: r.status
                    });
                });
                
                return activity.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
            },
            
            renderConceptNoteForm(content) {
                content.innerHTML = `
                    <div class="header">
                        <h2>Create Concept Note</h2>
                        <p>Step 1: Develop your concept note or Terms of Reference</p>
                    </div>
                    
                    <form class="form-grid two-col" onsubmit="app.submitConceptNote(event)">
                        <div class="form-group">
                            <label>Project Code <span class="required">*</span></label>
                            <select name="projectCode" required onchange="app.updateProjectBudget(this.value)">
                                <option value="">Select project</option>
                                ${this.data.projects.map(p => `
                                    <option value="${p.code}">${p.code} - ${p.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Activity Title <span class="required">*</span></label>
                            <input type="text" name="activityTitle" required placeholder="e.g., Radio Jingle Production - Kano">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Objective <span class="required">*</span></label>
                            <textarea name="objective" required placeholder="What is the purpose of this activity?"></textarea>
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Description <span class="required">*</span></label>
                            <textarea name="description" required placeholder="Detailed description of the activity"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Estimated Cost (₦) <span class="required">*</span></label>
                            <input type="number" name="estimatedCost" required min="0" step="0.01">
                        </div>
                        
                        <div class="form-group full-width">
                            <label>Are items/services to be procured? <span class="required">*</span></label>
                            <select name="requiresProcurement" required>
                                <option value="no">No - Direct payment</option>
                                <option value="yes">Yes - Procurement needed</option>
                            </select>
                            <span class="form-hint">Select "Yes" if items need to be purchased by Procurement team</span>
                        </div>
                        
                        <div class="form-group full-width" id="budgetInfo" class="threshold-info" style="display: none;">
                            <!-- Budget info will be inserted here -->
                        </div>
                        
                        <div class="btn-group full-width">
                            <button type="submit" class="btn btn-primary">Submit Concept Note</button>
                            <button type="button" class="btn btn-secondary" onclick="app.showView('dashboard')">Cancel</button>
                        </div>
                    </form>
                `;
            },
            
            // FIX #5: Add submitConceptNote method
            async submitConceptNote(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const conceptNote = {
                    refNumber: 'CN' + Date.now(),
                    staffName: this.currentUser,
                    projectCode: formData.get('projectCode'),
                    activityTitle: formData.get('activityTitle'),
                    objective: formData.get('objective'),
                    description: formData.get('description'),
                    estimatedCost: parseFloat(formData.get('estimatedCost')),
                    requiresProcurement: formData.get('requiresProcurement'),
                    status: 'pending',
                    submittedDate: new Date().toISOString()
                };
                
                const { data, error } = await supabaseClient
                    .from('concept_notes')
                    .insert([conceptNote])
                    .select();
                
                if (error) {
                    alert('Error submitting concept note: ' + error.message);
                } else {
                    this.data.conceptNotes.push(data[0]);
                    alert('Concept note submitted successfully!');
                    this.showView('dashboard');
                }
            },
            
            renderPaymentForm(content) {
                const approvedNotes = this.data.conceptNotes.filter(cn => 
                    cn.staffName === this.currentUser && cn.status === 'approved'
                );
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Request Payment</h2>
                        <p>Submit a payment request for an approved concept note</p>
                    </div>
                    
                    <form class="form-grid two-col" onsubmit="app.submitPayment(event)">
                        <div class="form-group full-width">
                            <label>Select Approved Concept Note <span class="required">*</span></label>
                            <select name="conceptNoteId" required onchange="app.loadConceptNoteDetails(this.value)">
                                <option value="">Choose a concept note</option>
                                ${approvedNotes.map(cn => `
                                    <option value="${cn.id}">${cn.refNumber} - ${cn.activityTitle}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div id="conceptNoteDetails" style="display: none;" class="form-group full-width">
                            <div class="threshold-info">
                                <div id="cnDetailsContent"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Amount (₦) <span class="required">*</span></label>
                            <input type="number" name="amount" required min="0" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label>Payment Method <span class="required">*</span></label>
                            <select name="paymentMethod" required>
                                <option value="bank_transfer">Bank Transfer</option>
                                <option value="cash">Cash</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
    <label>Justification</label>
    <textarea name="justification" placeholder="Additional payment information"></textarea>
</div>

<div class="form-group">
    <label>Account Name <span class="required">*</span></label>
    <input type="text" name="accountName" required placeholder="Name as it appears on bank account">
</div>

<div class="form-group">
    <label>Account Number <span class="required">*</span></label>
    <input type="text" name="accountNumber" required pattern="[0-9]{10}" maxlength="10" placeholder="10-digit account number">
</div>

<div class="form-group full-width">
    <label>Bank Name <span class="required">*</span></label>
    <select name="bankName" required>
        <option value="">Select Bank</option>
        <option value="Access Bank">Access Bank</option>
        <option value="Fidelity Bank">Fidelity Bank</option>
        <option value="First Bank">First Bank</option>
        <option value="FCMB">FCMB</option>
        <option value="GTBank">GTBank</option>
        <option value="Keystone Bank">Keystone Bank</option>
        <option value="Polaris Bank">Polaris Bank</option>
        <option value="Stanbic IBTC">Stanbic IBTC</option>
        <option value="UBA">UBA</option>
        <option value="Union Bank">Union Bank</option>
        <option value="Unity Bank">Unity Bank</option>
        <option value="Wema Bank">Wema Bank</option>
        <option value="Zenith Bank">Zenith Bank</option>
    </select>
</div>

<div class="btn-group full-width">
                    </form>
                `;
            },
            
            loadConceptNoteDetails(id) {
                const cn = this.data.conceptNotes.find(c => c.id == id);
                const detailsDiv = document.getElementById('conceptNoteDetails');
                const contentDiv = document.getElementById('cnDetailsContent');
                
                if (cn && detailsDiv && contentDiv) {
                    detailsDiv.style.display = 'block';
                    contentDiv.innerHTML = `
                        <strong>Activity:</strong> ${cn.activityTitle}<br>
                        <strong>Estimated Cost:</strong> ₦${cn.estimatedCost.toLocaleString()}<br>
                        <strong>Project:</strong> ${cn.projectCode}
                    `;
                }
            },
            
            async submitPayment(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const payment = {
    refNumber: 'PAY' + Date.now(),
    conceptNoteId: parseInt(formData.get('conceptNoteId')),
    staffName: this.currentUser,
    amount: parseFloat(formData.get('amount')),
    paymentMethod: formData.get('paymentMethod'),
    justification: formData.get('justification'),
    accountName: formData.get('accountName'),
    accountNumber: formData.get('accountNumber'),
    bankName: formData.get('bankName'),
    status: 'pending',
    requestDate: new Date().toISOString()
};
                
                const { data, error } = await supabaseClient
                    .from('payments')
                    .insert([payment])
                    .select();
                
                if (error) {
                    alert('Error submitting payment: ' + error.message);
                } else {
                    this.data.payments.push(data[0]);
                    alert('Payment request submitted successfully!');
                    this.showView('dashboard');
                }
            },
            
            // FIX #6: Add renderRetirementForm method
            renderRetirementForm(content) {
                const userRole = this.getUserRole();
                
                // Get payments that this user should retire
                const paidPayments = this.data.payments.filter(p => {
                    if (p.status !== 'paid') return false;
                    if (this.data.retirements.find(r => r.paymentRef === p.refNumber)) return false;
                    
                    // Check if payment has paidDate and calculate days
                    if (!p.paidDate) return false;
                    const daysSincePaid = Math.floor((Date.now() - new Date(p.paidDate)) / (1000 * 60 * 60 * 24));
                    
                    // Staff can retire after 5 days if they're responsible
                    if (userRole === 'staff' && p.retirementresponsibility === 'staff' && p.staffName === this.currentUser) {
                        return daysSincePaid >= 5;
                    }
                    
                    // Procurement can retire immediately if they're responsible
                    if (userRole === 'procurement' && p.retirementresponsibility === 'procurement') {
                        return true;
                    }
                    
                    return false;
                });
                
                // Get payments waiting for 5 days (for staff)
                const waitingPayments = this.data.payments.filter(p => {
                    if (p.status !== 'paid') return false;
                    if (this.data.retirements.find(r => r.paymentRef === p.refNumber)) return false;
                    if (!p.paidDate) return false;
                    
                    const daysSincePaid = Math.floor((Date.now() - new Date(p.paidDate)) / (1000 * 60 * 60 * 24));
                    
                    return userRole === 'staff' && 
                           p.retirementresponsibility === 'staff' && 
                           p.staffName === this.currentUser && 
                           daysSincePaid < 5;
                });
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Submit Retirement</h2>
                        <p>${userRole === 'procurement' ? 'Retire procured activities' : 'Retire advance payments (available 5 days after payment)'}</p>
                    </div>
                    
                    ${waitingPayments.length > 0 && userRole === 'staff' ? `
                        <div class="alert-badge warning" style="display: block; margin-bottom: 24px;">
                            ⏳ You have ${waitingPayments.length} payment(s) waiting for the 5-day period before retirement can be submitted
                        </div>
                    ` : ''}
                    
                    ${paidPayments.length === 0 ? `
                        <div class="empty-state">
                            <h3>No payments to retire</h3>
                            <p>${userRole === 'procurement' ? 
                                "You don't have any procured activities that need retirement." : 
                                "You don't have any paid advances ready for retirement."}</p>
                        </div>
                    ` : `
                        <form class="form-grid two-col" onsubmit="app.submitRetirement(event)">
                            <div class="form-group full-width">
                                <label>Select Payment to Retire <span class="required">*</span></label>
                                <select name="paymentRef" required onchange="app.loadPaymentDetails(this.value)">
                                    <option value="">Choose a payment</option>
                                    ${paidPayments.map(p => {
                                        const daysSince = Math.floor((Date.now() - new Date(p.paidDate)) / (1000 * 60 * 60 * 24));
                                        return `<option value="${p.refNumber}">${p.refNumber} - ₦${p.amount.toLocaleString()} (Paid ${daysSince} days ago)</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Actual Amount Spent (₦) <span class="required">*</span></label>
                                <input type="number" name="actualSpent" required min="0" step="0.01">
                            </div>
                            
                            <div class="form-group">
                                <label>Amount to Return (₦)</label>
                                <input type="number" name="amountReturned" min="0" step="0.01" value="0">
                            </div>
                            
                            <div class="form-group full-width">
                                <label>Expenditure Details <span class="required">*</span></label>
                                <textarea name="expenditureDetails" required placeholder="Describe how the funds were spent"></textarea>
                            </div>
                            
                            <div class="form-group full-width">
                                <label>Attachments/Receipts</label>
                                <input type="text" name="attachments" placeholder="List of attached receipts">
                                <span class="form-hint">Upload receipts separately and list them here</span>
                            </div>
                            
                            <div class="btn-group full-width">
                                <button type="submit" class="btn btn-primary">Submit Retirement</button>
                                <button type="button" class="btn btn-secondary" onclick="app.showView('dashboard')">Cancel</button>
                            </div>
                        </form>
                    `}
                `;
            },
            
            loadPaymentDetails(refNumber) {
                const payment = this.data.payments.find(p => p.refNumber === refNumber);
                if (payment) {
                    const form = document.querySelector('form');
                    const actualSpentInput = form.querySelector('[name="actualSpent"]');
                    if (actualSpentInput) {
                        actualSpentInput.max = payment.amount;
                    }
                }
            },
            
            async submitRetirement(event) {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                
                const retirement = {
                    refNumber: 'RET' + Date.now(),
                    staffName: this.currentUser,
                    paymentRef: formData.get('paymentRef'),
                    actualSpent: parseFloat(formData.get('actualSpent')),
                    amountReturned: parseFloat(formData.get('amountReturned')) || 0,
                    expenditureDetails: formData.get('expenditureDetails'),
                    attachments: formData.get('attachments'),
                    status: 'pending',
                    submittedDate: new Date().toISOString()
                };
                
                const { data, error } = await supabaseClient
                    .from('retirements')
                    .insert([retirement])
                    .select();
                
                if (error) {
                    alert('Error submitting retirement: ' + error.message);
                } else {
                    this.data.retirements.push(data[0]);
                    alert('Retirement submitted successfully!');
                    this.showView('dashboard');
                }
            },
            
            // FIX #7: Add renderApprovals method with full approval logic
            renderApprovals(content) {
                const role = this.getUserRole();
                
                // Get items pending this user's approval
                const pendingConceptNotes = this.data.conceptNotes.filter(cn => {
                    if (cn.status !== 'pending') return false;
                    
                    // Budget Owner sees all pending
                    if (role === 'budgetOwner' && cn.currentApprover === 'budgetOwner') return true;
                    
                    // ED sees only those >1M forwarded by Budget Owner
                    if (role === 'ed' && cn.currentApprover === 'ed') return true;
                    
                    // Procurement sees those flagged for procurement
                    if (role === 'procurement' && cn.currentApprover === 'procurement') return true;
                    
                    return false;
                });
                
                const pendingPayments = this.data.payments.filter(p => 
                    p.status === 'pending' && role === 'finance'
                );
                
                const pendingRetirements = this.data.retirements.filter(r => 
                    r.status === 'pending' && role === 'finance'
                );
                
                content.innerHTML = `
                    <div class="header">
                        <h2>My Approvals</h2>
                        <p>Items requiring your review and approval</p>
                    </div>
                    
                    ${pendingConceptNotes.length === 0 && pendingPayments.length === 0 && pendingRetirements.length === 0 ? `
                        <div class="empty-state">
                            <h3>No pending approvals</h3>
                            <p>You don't have any items waiting for your approval.</p>
                        </div>
                    ` : ''}
                    
                    ${pendingConceptNotes.length > 0 ? `
                        <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Concept Notes (${pendingConceptNotes.length})</h3>
                        <div class="table-container" style="margin-bottom: 32px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref</th>
                                        <th>Staff</th>
                                        <th>Activity</th>
                                        <th>Project</th>
                                        <th>Amount</th>
                                        <th>Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingConceptNotes.map(cn => `
                                        <tr>
                                            <td>${cn.refNumber}</td>
                                            <td>${cn.staffName}</td>
                                            <td>${cn.activityTitle}</td>
                                            <td>${cn.projectCode}</td>
                                            <td>₦${cn.estimatedCost.toLocaleString()}</td>
                                            <td>${new Date(cn.submittedDate).toLocaleDateString()}</td>
                                            <td>
    <button class="action-btn" onclick="app.viewConceptNoteDetails('${cn.refNumber}')" style="min-width:120px;margin-bottom:8px;border-color:var(--primary);color:var(--primary);">
        📄 View Details
    </button><br>
    ${role === 'budgetOwner' ? `
        ${cn.estimatedCost <= 1000000 ? `
            <button class="action-btn approve" onclick="app.approveConceptNote('${cn.refNumber}', 'approve_under_1m')">
                ✓ Approve${cn.requiresProcurement === 'yes' ? ' → Procurement' : ''}
            </button>
                                                    `}
                                                ` : role === 'ed' ? `
                                                    <button class="action-btn approve" onclick="app.approveConceptNote('${cn.refNumber}', 'ed_approve')">
                                                        ✓ Approve${cn.requiresProcurement === 'yes' ? ' → Procurement' : ''}
                                                    </button>
                                                ` : role === 'procurement' ? `
                                                    <button class="action-btn approve" onclick="app.approveConceptNote('${cn.refNumber}', 'procurement_complete')">
                                                        ✓ Complete & Forward to Finance
                                                    </button>
                                                ` : ''}
                                                <button class="action-btn reject" onclick="app.rejectConceptNote('${cn.refNumber}')">
                                                    ✗ Reject
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                    
                    ${pendingPayments.length > 0 ? `
                        <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Payment Requests (${pendingPayments.length})</h3>
                        <div class="table-container" style="margin-bottom: 32px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref</th>
                                        <th>Staff</th>
                                        <th>Amount</th>
                                        <th>Type</th>
                                        <th>Requested</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingPayments.map(p => `
                                        <tr>
                                            <td>${p.refNumber}</td>
                                            <td>${p.staffName}</td>
                                            <td>₦${p.amount.toLocaleString()}</td>
                                            <td>${p.paymentType}</td>
                                            <td>${new Date(p.requestDate).toLocaleDateString()}</td>
                                            <td>
                                                <button class="action-btn approve" onclick="app.processPayment('${p.refNumber}')">
                                                    ✓ Process Payment
                                                </button>
                                                <button class="action-btn reject" onclick="app.rejectPayment('${p.refNumber}')">
                                                    ✗ Reject
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                    
                    ${pendingRetirements.length > 0 ? `
                        <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Retirement Submissions (${pendingRetirements.length})</h3>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ref</th>
                                        <th>Staff</th>
                                        <th>Payment Ref</th>
                                        <th>Spent</th>
                                        <th>Returned</th>
                                        <th>Submitted</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${pendingRetirements.map(r => `
                                        <tr>
                                            <td>${r.refNumber}</td>
                                            <td>${r.staffName}</td>
                                            <td>${r.paymentRef}</td>
                                            <td>₦${r.actualSpent.toLocaleString()}</td>
                                            <td>₦${r.amountReturned.toLocaleString()}</td>
                                            <td>${new Date(r.submittedDate).toLocaleDateString()}</td>
                                            <td>
                                                <button class="action-btn approve" onclick="app.approveRetirement('${r.refNumber}')">
                                                    ✓ Approve Retirement
                                                </button>
                                                <button class="action-btn reject" onclick="app.rejectRetirement('${r.refNumber}')">
                                                    ✗ Reject
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                `;
            },
            
            // APPROVAL LOGIC METHODS
            async approveConceptNote(refNumber, action) {
                const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
                if (!cn) return;
                
                let updates = {};
                
                switch(action) {
                    case 'approve_under_1m':
                        // Budget Owner approving ≤₦1M
                        if (cn.requiresProcurement === 'yes') {
                            // Route to procurement first
                            updates = {
                                currentApprover: 'procurement',
                                sentToProcurement: new Date().toISOString(),
                                retirementresponsibility: 'procurement'
                            };
                        } else {
                            // Direct to finance - staff will retire
                            updates = {
                                status: 'approved',
                                approvedDate: new Date().toISOString(),
                                approvedBy: this.currentUser,
                                retirementresponsibility: 'staff'
                            };
                        }
                        break;
                    case 'forward_to_ed':
                        // Budget Owner forwarding >₦1M to ED
                        updates = {
                            currentApprover: 'ed',
                            forwardedToED: new Date().toISOString()
                        };
                        break;
                    case 'ed_approve':
                        // ED approving >₦1M
                        if (cn.requiresProcurement === 'yes') {
                            // Route to procurement
                            updates = {
                                currentApprover: 'procurement',
                                sentToProcurement: new Date().toISOString(),
                                retirementresponsibility: 'procurement'
                            };
                        } else {
                            // Direct to finance - staff will retire
                            updates = {
                                status: 'approved',
                                approvedDate: new Date().toISOString(),
                                approvedBy: this.currentUser,
                                retirementresponsibility: 'staff'
                            };
                        }
                        break;
                    case 'procurement_complete':
    // Show upload form instead
    this.showProcurementUpload(refNumber);
    return; // Exit - modal handles completion
                }
                
                const { error } = await supabaseClient
                    .from('concept_notes')
                    .update(updates)
                    .eq('refNumber', refNumber);
                
                if (error) {
                    alert('Error updating concept note: ' + error.message);
                } else {
                    Object.assign(cn, updates);
                    alert('Concept note processed successfully!');
                    await this.loadData();
                    this.showView('approvals');
                }
            },
            
            async rejectConceptNote(refNumber) {
                const reason = prompt('Please provide a reason for rejection:');
                if (!reason) return;
                
                const { error } = await supabaseClient
                    .from('concept_notes')
                    .update({
                        status: 'rejected',
                        rejectedDate: new Date().toISOString(),
                        rejectedBy: this.currentUser,
                        rejectionReason: reason
                    })
                    .eq('refNumber', refNumber);
                
                if (error) {
                    alert('Error rejecting concept note: ' + error.message);
                } else {
                    alert('Concept note rejected.');
                    await this.loadData();
                    this.showView('approvals');
                }
            },
            showProcurementUpload(refNumber) {
    const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
    if (!cn) return;
    
    const content = document.getElementById('mainContent');
    content.innerHTML = `
        <div class="header">
            <h2>Complete Procurement & Forward to Finance</h2>
            <p>Upload documents and create payment request</p>
        </div>
        
        <div class="form-grid">
            <div class="form-group full-width">
                <div class="threshold-info">
                    <strong>Concept Note:</strong> ${cn.refNumber} - ${cn.activityTitle}<br>
                    <strong>Amount:</strong> ₦${cn.estimatedCost.toLocaleString()}<br>
                    <strong>Staff:</strong> ${cn.staffName}
                </div>
            </div>
            
            <div class="form-group full-width">
                <label>Upload GRR (Goods Received Report) <span class="required">*</span></label>
                <input type="file" id="grrFile" accept=".pdf,.jpg,.jpeg,.png" required>
            </div>
            
            <div class="form-group full-width">
                <label>Upload Purchase Order/Invoice <span class="required">*</span></label>
                <input type="file" id="poFile" accept=".pdf,.jpg,.jpeg,.png" required>
            </div>
            
            <div class="form-group full-width">
                <label>Procurement Notes</label>
                <textarea id="procNotes" rows="3" placeholder="Additional information for Finance..."></textarea>
            </div>
            
            <div class="btn-group full-width">
                <button class="btn btn-primary" onclick="app.completeProcurementWithDocs('${refNumber}')">
                    Complete & Send to Finance
                </button>
                <button class="btn btn-secondary" onclick="app.showView('approvals')">
                    Cancel
                </button>
            </div>
        </div>
    `;
},

async completeProcurementWithDocs(refNumber) {
    const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
    if (!cn) return;
    
    const grrFile = document.getElementById('grrFile').files[0];
    const poFile = document.getElementById('poFile').files[0];
    const notes = document.getElementById('procNotes').value;
    
    if (!grrFile || !poFile) {
        alert('Please upload both GRR and PO/Invoice documents');
        return;
    }
    
    // Convert files to base64
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
    
    try {
        const grrData = await toBase64(grrFile);
        const poData = await toBase64(poFile);
        
        // Update concept note
        const { error: cnError } = await supabaseClient
            .from('concept_notes')
            .update({
                status: 'approved',
                approvedDate: new Date().toISOString(),
                approvedBy: this.currentUser,
                procurementComplete: new Date().toISOString(),
                retirementresponsibility: 'procurement',
                grrFile: grrData,
                grrFileName: grrFile.name,
                poFile: poData,
                poFileName: poFile.name,
                procurementNotes: notes
            })
            .eq('refNumber', refNumber);
        
        if (cnError) throw cnError;
        
        // AUTO-CREATE PAYMENT REQUEST for Finance
        const payment = {
            refNumber: 'PAY' + Date.now(),
            conceptNoteId: cn.id,
            conceptNoteRef: cn.refNumber,
            projectCode: cn.projectCode,
            staffName: cn.staffName,
            amount: cn.estimatedCost,
            paymentMethod: 'bank_transfer',
            justification: `Procurement completed by ${this.currentUser}. ${notes}`,
            status: 'pending',
            requestDate: new Date().toISOString(),
            procurementComplete: true,
            retirementresponsibility: 'procurement'
        };
        
        const { error: payError } = await supabaseClient
            .from('payments')
            .insert([payment])
            .select();
        
        if (payError) throw payError;
        
        alert('Procurement completed and payment request sent to Finance!');
        await this.loadData();
        this.showView('approvals');
        
    } catch (error) {
        alert('Error: ' + error.message);
    }
},
           async processPayment(refNumber) {
    const payment = this.data.payments.find(p => p.refNumber === refNumber);
    if (!payment) return;
    
    async processPayment(refNumber) {
    const payment = this.data.payments.find(p => p.refNumber === refNumber);
    if (!payment) return;
    
    // Check if account details already provided
    if (!payment.accountName || !payment.accountNumber || !payment.bankName) {
        alert('Error: Account details not provided by staff member. Please contact the staff to update their payment request with bank details.');
        return;
    }
    
    // Show confirmation before processing
    if (!confirm(`Process payment of ₦${payment.amount.toLocaleString()} to:\n\nAccount Name: ${payment.accountName}\nAccount Number: ${payment.accountNumber}\nBank: ${payment.bankName}\n\nConfirm payment?`)) {
        return;
    }
    
    const conceptNote = this.data.conceptNotes.find(cn => cn.refNumber === payment.conceptNoteRef);
    
    const { error } = await supabaseClient
        .from('payments')
        .update({
            status: 'paid',
            paidDate: new Date().toISOString(),
            processedBy: this.currentUser,
            retirementresponsibility: conceptNote?.retirementresponsibility || 'staff'
        })
        .eq('refNumber', refNumber);
    
    if (error) {
        alert('Error processing payment: ' + error.message);
    } else {
        alert(`Payment of ₦${payment.amount.toLocaleString()} processed successfully!`);
        await this.loadData();
        this.showView('approvals');
    }
},

viewConceptNoteDetails(refNumber) {
    const cn = this.data.conceptNotes.find(c => c.refNumber === refNumber);
    if (!cn) return;
    
    const content = document.getElementById('mainContent');
    content.innerHTML = `
        <div class="header">
            <h2>Concept Note Details</h2>
            <p>Full information for ${cn.refNumber}</p>
        </div>
        
        <div class="form-grid two-col">
            <div class="form-group">
                <label>Reference Number</label>
                <input type="text" value="${cn.refNumber}" readonly>
            </div>
            
            <div class="form-group">
                <label>Status</label>
                <span class="status-badge status-${cn.status}">${cn.status}</span>
            </div>
            
            <div class="form-group">
                <label>Staff Name</label>
                <input type="text" value="${cn.staffName}" readonly>
            </div>
            
            <div class="form-group">
                <label>Submitted Date</label>
                <input type="text" value="${new Date(cn.submittedDate).toLocaleString()}" readonly>
            </div>
            
            <div class="form-group">
                <label>Project Code</label>
                <input type="text" value="${cn.projectCode}" readonly>
            </div>
            
            <div class="form-group">
                <label>Estimated Cost</label>
                <input type="text" value="₦${cn.estimatedCost.toLocaleString()}" readonly>
            </div>
            
            <div class="form-group full-width">
                <label>Activity Title</label>
                <input type="text" value="${cn.activityTitle}" readonly>
            </div>
            
            <div class="form-group full-width">
                <label>Objective</label>
                <textarea rows="3" readonly>${cn.objective}</textarea>
            </div>
            
            <div class="form-group full-width">
                <label>Description</label>
                <textarea rows="4" readonly>${cn.description}</textarea>
            </div>
            
            <div class="form-group">
                <label>Requires Procurement?</label>
                <input type="text" value="${cn.requiresProcurement === 'yes' ? 'Yes' : 'No'}" readonly>
            </div>
            
            ${cn.procurementNotes ? `
                <div class="form-group full-width">
                    <label>Procurement Notes</label>
                    <textarea rows="2" readonly>${cn.procurementNotes}</textarea>
                </div>
            ` : ''}
            
            ${cn.grrFileName ? `
                <div class="form-group">
                    <label>GRR Document</label>
                    <input type="text" value="${cn.grrFileName}" readonly>
                </div>
            ` : ''}
            
            ${cn.poFileName ? `
                <div class="form-group">
                    <label>PO/Invoice Document</label>
                    <input type="text" value="${cn.poFileName}" readonly>
                </div>
            ` : ''}
            
            <div class="btn-group full-width">
                <button class="btn btn-primary" onclick="app.showView('approvals')">
                    ← Back to Approvals
                </button>
            </div>
        </div>
    `;
},
            
            async rejectPayment(refNumber) {
                const reason = prompt('Please provide a reason for rejection:');
                if (!reason) return;
                
                const { error } = await supabaseClient
                    .from('payments')
                    .update({
                        status: 'rejected',
                        rejectedDate: new Date().toISOString(),
                        rejectedBy: this.currentUser,
                        rejectionReason: reason
                    })
                    .eq('refNumber', refNumber);
                
                if (error) {
                    alert('Error rejecting payment: ' + error.message);
                } else {
                    alert('Payment rejected.');
                    await this.loadData();
                    this.showView('approvals');
                }
            },
            
            async approveRetirement(refNumber) {
                const { error } = await supabaseClient
                    .from('retirements')
                    .update({
                        status: 'approved',
                        approvedDate: new Date().toISOString(),
                        approvedBy: this.currentUser
                    })
                    .eq('refNumber', refNumber);
                
                if (error) {
                    alert('Error approving retirement: ' + error.message);
                } else {
                    alert('Retirement approved successfully!');
                    await this.loadData();
                    this.showView('approvals');
                }
            },
            
            async rejectRetirement(refNumber) {
                const reason = prompt('Please provide a reason for rejection:');
                if (!reason) return;
                
                const { error } = await supabaseClient
                    .from('retirements')
                    .update({
                        status: 'rejected',
                        rejectedDate: new Date().toISOString(),
                        rejectedBy: this.currentUser,
                        rejectionReason: reason
                    })
                    .eq('refNumber', refNumber);
                
                if (error) {
                    alert('Error rejecting retirement: ' + error.message);
                } else {
                    alert('Retirement rejected.');
                    await this.loadData();
                    this.showView('approvals');
                }
            },
            
            // FIX #8: Add renderReports method
            renderReports(content) {
                const role = this.getUserRole();
                
                if (!['budgetOwner','ed','procurement','finance'].includes(role)) {
                    content.innerHTML = `
                        <div class="empty-state">
                            <h3>Access Denied</h3>
                            <p>You don't have permission to view reports.</p>
                        </div>
                    `;
                    return;
                }
                
                // Calculate budget usage per project
                const projectStats = this.data.projects.map(project => {
                    const spent = this.getProjectSpent(project.code);
                    const remaining = project.budget - spent;
                    const percentUsed = (spent / project.budget * 100).toFixed(1);
                    
                    return {
                        ...project,
                        spent,
                        remaining,
                        percentUsed
                    };
                });
                
                content.innerHTML = `
                    <div class="header">
                        <h2>Reports & Budget Tracking</h2>
                        <p>Financial overview and budget utilization</p>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Budget</h3>
                            <div class="stat-value">₦${this.data.projects.reduce((sum, p) => sum + p.budget, 0).toLocaleString()}</div>
                            <div class="stat-label">Across all projects</div>
                        </div>
                        <div class="stat-card warning">
                            <h3>Total Spent</h3>
                            <div class="stat-value">₦${this.data.payments.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.amount, 0).toLocaleString()}</div>
                            <div class="stat-label">All paid requests</div>
                        </div>
                        <div class="stat-card">
                            <h3>Pending Approvals</h3>
                            <div class="stat-value">${this.data.conceptNotes.filter(cn => cn.status === 'pending').length}</div>
                            <div class="stat-label">Concept notes awaiting review</div>
                        </div>
                        <div class="stat-card danger">
                            <h3>Unretired Advances</h3>
                            <div class="stat-value">${this.data.payments.filter(p => p.status === 'paid' && !this.data.retirements.find(r => r.paymentRef === p.refNumber)).length}</div>
                            <div class="stat-label">Need retirement</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 16px; font-family: 'Archivo', sans-serif;">Project Budget Status</h3>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Project Code</th>
                                    <th>Project Name</th>
                                    <th>Total Budget</th>
                                    <th>Spent</th>
                                    <th>Remaining</th>
                                    <th>Usage</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${projectStats.map(p => `
                                    <tr>
                                        <td><strong>${p.code}</strong></td>
                                        <td>${p.name}</td>
                                        <td>₦${p.budget.toLocaleString()}</td>
                                        <td>₦${p.spent.toLocaleString()}</td>
                                        <td>₦${p.remaining.toLocaleString()}</td>
                                        <td>
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div class="budget-bar" style="flex: 1; margin: 0;">
                                                    <div class="budget-fill ${p.percentUsed > 90 ? 'danger' : p.percentUsed > 70 ? 'warning' : ''}" 
                                                         style="width: ${p.percentUsed}%"></div>
                                                </div>
                                                <span style="font-weight: 600; min-width: 50px;">${p.percentUsed}%</span>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },
            
            // FIX #9: Add renderSettings method
            renderSettings(content) {
                content.innerHTML = `
                    <div class="header">
                        <h2>Settings</h2>
                        <p>System configuration and user preferences</p>
                    </div>
                    
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <h3 style="margin-bottom: 16px;">User Information</h3>
                            <p><strong>Name:</strong> ${this.currentUser}</p>
                            <p><strong>Role:</strong> ${this.getUserRole() === 'staff' ? 'Staff Member' : this.getUserRole().toUpperCase()}</p>
                        </div>
                        
                        <div class="form-group full-width">
                            <h3 style="margin-bottom: 16px;">System Information</h3>
                            <p><strong>Version:</strong> 1.0.0</p>
                            <p><strong>Last Updated:</strong> ${new Date().toLocaleDateString()}</p>
                        </div>
                        
                        <div class="btn-group full-width">
                            <button class="btn btn-primary" onclick="app.showView('dashboard')">Back to Dashboard</button>
                            <button class="btn btn-secondary" onclick="app.logout()">Logout</button>
                        </div>
                    </div>
                `;
            },
            
            logout() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('pms_user');
                    window.location.href = 'https://rahamaorg.github.io/appraisal-system/';
                }
            }
        };
        
        // Initialize app when page loads
        window.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
